pipeline {
    agent any
    parameters {
        choice(name: 'ACTION',
               choices: ['build_and_deploy', 'skip_build'],
               description: 'ë°±ì—”ë“œ ë¹Œë“œ ë° ë°°í¬ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')
        string(name: 'VERSION', defaultValue: '1.0', description: 'ê¸°ë³¸ ë²„ì „')
    }
    environment {
        ECR_REGISTRY = '382045063773.dkr.ecr.ap-northeast-2.amazonaws.com'
        AWS_REGION = 'ap-northeast-2'
        GIT_CREDENTIAL_ID = 'github-cred'
        SONARQUBE_NAME = 'SonarQube'
        SONAR_HOST_URL = 'http://192.168.0.170:32000'
        MANIFEST_REPO_URL = 'https://github.com/Alphacar-project/alphacar-k8s.git'
        
        // ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ëª©ë¡
        BACKEND_SERVICES = 'main,community,news,quote,search,mypage,aichat'
    }
    
    stages {
        stage('1. Prepare & Detect Changes') {
            when { expression { params.ACTION == 'build_and_deploy' } }
            steps {
                script {
                    cleanWs()
                    checkout scm
                    
                    // ë³€ê²½ ê°ì§€
                    echo "ğŸ” ë³€ê²½ëœ íŒŒì¼ í™•ì¸ ì¤‘..."
                    def commitMessage = sh(script: 'git log -1 --pretty=%B', returnStdout: true).trim()
                    echo "ì»¤ë°‹ ë©”ì‹œì§€: ${commitMessage}"
                    
                    // [skip ci] ì»¤ë°‹ ì²´í¬
                    if (commitMessage.contains('[skip ci]')) {
                        echo "â­ï¸ [skip ci] ì»¤ë°‹ ê°ì§€ - ë¹Œë“œë¥¼ ìŠ¤í‚µí•©ë‹ˆë‹¤."
                        currentBuild.result = 'SUCCESS'
                        currentBuild.displayName = "#${currentBuild.number} (Skipped - [skip ci])"
                        return
                    }
                    
                    // ìµœê·¼ ì»¤ë°‹ì˜ ë³€ê²½ íŒŒì¼ í™•ì¸
                    def changedFiles = sh(script: 'git diff --name-only HEAD~1 HEAD 2>/dev/null || echo ""', returnStdout: true).trim()
                    echo "ë³€ê²½ëœ íŒŒì¼ (HEAD~1 vs HEAD):\n${changedFiles}"
                    
                    // ë³€ê²½ íŒŒì¼ì´ ì—†ìœ¼ë©´ ìµœê·¼ 2ê°œ ì»¤ë°‹ ë¹„êµ
                    if (!changedFiles || changedFiles.trim().isEmpty()) {
                        def recentCommits = sh(script: 'git log -2 --pretty=%H', returnStdout: true).trim().split('\n')
                        if (recentCommits.size() >= 2) {
                            changedFiles = sh(script: "git diff --name-only ${recentCommits[1]} ${recentCommits[0]} 2>/dev/null || echo \"\"", returnStdout: true).trim()
                            echo "ë³€ê²½ëœ íŒŒì¼ (ìµœê·¼ 2ê°œ ì»¤ë°‹ ë¹„êµ):\n${changedFiles}"
                        }
                    }
                    
                    if (!changedFiles || changedFiles.trim().isEmpty()) {
                        echo "âš ï¸ ë³€ê²½ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
                        currentBuild.result = 'SUCCESS'
                        currentBuild.displayName = "#${currentBuild.number} (Skipped - No changes)"
                        return
                    }
                    
                    // ë³€ê²½ëœ ì„œë¹„ìŠ¤ ê°ì§€
                    def services = ['main', 'community', 'news', 'quote', 'search', 'mypage', 'aichat']
                    def changedServices = []
                    def fileList = changedFiles.split('\n')
                    
                    for (file in fileList) {
                        file = file.trim()
                        // Jenkinsfile ë³€ê²½ì€ ë¬´ì‹œ
                        if (file.contains('Jenkinsfile') && !file.contains('dev/alphacar/backend')) {
                            continue
                        }
                        // ê° ì„œë¹„ìŠ¤ ê²½ë¡œ í™•ì¸
                        for (service in services) {
                            if (file.contains("dev/alphacar/backend/${service}")) {
                                if (!changedServices.contains(service)) {
                                    changedServices.add(service)
                                    echo "âœ… ${service} ê´€ë ¨ ë³€ê²½ ê°ì§€: ${file}"
                                }
                            }
                        }
                    }
                    
                    if (changedServices.isEmpty()) {
                        echo "â­ï¸ ë°±ì—”ë“œ ê²½ë¡œ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. ë¹Œë“œë¥¼ ìŠ¤í‚µí•©ë‹ˆë‹¤."
                        echo "ë³€ê²½ëœ ê²½ë¡œ:\n${changedFiles}"
                        currentBuild.result = 'SUCCESS'
                        currentBuild.displayName = "#${currentBuild.number} (Skipped - No backend changes)"
                        return
                    }
                    
                    echo "âœ… ë³€ê²½ëœ ì„œë¹„ìŠ¤: ${changedServices.join(', ')}"
                    env.CHANGED_SERVICES = changedServices.join(',')
                    
                    // ë””ìŠ¤í¬ ê³µê°„ í™•ë³´ë¥¼ ìœ„í•œ Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬
                    sh '''
                        echo "ğŸ§¹ ë¹Œë“œ ì „ Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì¤‘..."
                        docker image prune -f || true
                        docker container prune -f || true
                        docker builder prune -f || true
                        echo "âœ… Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì™„ë£Œ"
                    '''
                    
                    def baseVer = "1.0"
                    def versionPath = 'dev/alphacar/backend/version.txt'
                    if (fileExists(versionPath)) {
                        baseVer = readFile(versionPath).trim()
                    }
                    env.GIT_SHA = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    env.FULL_VERSION = "${baseVer}.${currentBuild.number}-${env.GIT_SHA}"
                    echo "ğŸ“¦ ë¹Œë“œ ë²„ì „: ${env.FULL_VERSION}"
                }
            }
        }
        
        // ê° ì„œë¹„ìŠ¤ë³„ë¡œ ë³‘ë ¬ ë¹Œë“œ
        stage('2. Build Services') {
            when { expression { params.ACTION == 'build_and_deploy' && env.CHANGED_SERVICES } }
            parallel {
                stage('Build main') {
                    when { expression { env.CHANGED_SERVICES.contains('main') } }
                    steps {
                        script {
                            buildService('main', 'alphacar-main')
                        }
                    }
                }
                stage('Build community') {
                    when { expression { env.CHANGED_SERVICES.contains('community') } }
                    steps {
                        script {
                            buildService('community', 'alphacar-community')
                        }
                    }
                }
                stage('Build news') {
                    when { expression { env.CHANGED_SERVICES.contains('news') } }
                    steps {
                        script {
                            buildService('news', 'alphacar-news')
                        }
                    }
                }
                stage('Build quote') {
                    when { expression { env.CHANGED_SERVICES.contains('quote') } }
                    steps {
                        script {
                            buildService('quote', 'alphacar-quote')
                        }
                    }
                }
                stage('Build search') {
                    when { expression { env.CHANGED_SERVICES.contains('search') } }
                    steps {
                        script {
                            buildService('search', 'alphacar-search')
                        }
                    }
                }
                stage('Build mypage') {
                    when { expression { env.CHANGED_SERVICES.contains('mypage') } }
                    steps {
                        script {
                            buildService('mypage', 'alphacar-mypage')
                        }
                    }
                }
                stage('Build aichat') {
                    when { expression { env.CHANGED_SERVICES.contains('aichat') } }
                    steps {
                        script {
                            buildService('aichat', 'alphacar-aichat')
                        }
                    }
                }
            }
        }
    }
    
    post {
        always {
            sh """
                docker image prune -f || true
                docker container prune -f || true
                docker builder prune -f || true
            """
            cleanWs()
        }
    }
}

// ì„œë¹„ìŠ¤ ë¹Œë“œ í•¨ìˆ˜
def buildService(String appName, String imageName) {
    echo "ğŸš€ ${appName} ì„œë¹„ìŠ¤ ë¹Œë“œ ì‹œì‘"
    
    def imageFullTag = "${env.ECR_REGISTRY}/alphacar/${imageName}:${env.FULL_VERSION}"
    def backendPath = "dev/alphacar/backend/${appName}"
    def manifestPath = "k8s/backend/${appName}-backend.yaml"
    
    // SonarQube ë¶„ì„ (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
    dir(backendPath) {
        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
            script {
                def scannerHome = tool name: 'sonar-scanner'
                withSonarQubeEnv('sonarqube') {
                            sh """
                        ${scannerHome}/bin/sonar-scanner \\
                            -Dsonar.projectKey=${imageName} \\
                            -Dsonar.sources=. \\
                            -Dsonar.host.url=http://localhost:9000 \\
                            -Dsonar.token=squ_273d18a8d287084a242da2c1ea88fcebc4090873 || echo "âš ï¸ SonarQube ë¶„ì„ ì‹¤íŒ¨ - ê³„ì† ì§„í–‰"
                    """
                }
            }
        }
    }
    
    // Docker ë¹Œë“œ ë° í‘¸ì‹œ
    dir(backendPath) {
        echo "ğŸ³ ë„ì»¤ ë¹Œë“œ ì‹œì‘: ${imageFullTag}"
        sh "docker build --build-arg APP_NAME=${appName} --build-arg BUILDKIT_INLINE_CACHE=1 -f Dockerfile -t ${imageFullTag} ."
        
        script {
            def awsPath = sh(script: 'which aws || echo /usr/local/bin/aws', returnStdout: true).trim()
            if (!awsPath || !fileExists(awsPath)) {
                error "AWS CLI not found. Please install AWS CLI on the Jenkins server."
            }
            sh """
                ${awsPath} ecr get-login-password --region ${env.AWS_REGION} | \\
                docker login --username AWS --password-stdin ${env.ECR_REGISTRY}
            """
        }
        
        sh "docker push ${imageFullTag}"
        sh "docker logout ${env.ECR_REGISTRY}"
        echo "âœ… ECR í‘¸ì‹œ ì™„ë£Œ: ${imageFullTag}"
    }
    
    // Manifest ì—…ë°ì´íŠ¸
    dir('manifest-update') {
        checkout([$class: 'GitSCM', 
            branches: [[name: 'main']], 
            userRemoteConfigs: [[url: "${env.MANIFEST_REPO_URL}", credentialsId: "${env.GIT_CREDENTIAL_ID}"]]
        ])
        
        withCredentials([usernamePassword(credentialsId: env.GIT_CREDENTIAL_ID, usernameVariable: 'GH_USER', passwordVariable: 'GH_TOKEN')]) {
            sh """
                git checkout -B main || git checkout main
                if [ -f "${manifestPath}" ]; then
                    sed -i "s|image: .*/${imageName}:.*|image: ${imageFullTag}|" ${manifestPath}
                    echo "âœ… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${manifestPath}"
                fi
                git config user.email "jenkins@alphacar.com"
                git config user.name "Jenkins-CI"
                git add .
                if [ -n "\$(git status --porcelain)" ]; then
                    git commit -m "Update ${imageName} image to ${env.FULL_VERSION} [skip ci]"
                    git push https://\${GH_TOKEN}@github.com/Alphacar-project/alphacar-k8s.git HEAD:main
                    echo "âœ… GitOps ë ˆí¬ì§€í† ë¦¬ í‘¸ì‹œ ì„±ê³µ"
                fi
            """
        }
    }
    
    echo "âœ… ${appName} ì„œë¹„ìŠ¤ ë¹Œë“œ ì™„ë£Œ"
}

