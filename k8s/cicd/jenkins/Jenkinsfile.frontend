pipeline {
    agent any

    environment {
        ECR_REGISTRY = '382045063773.dkr.ecr.ap-northeast-2.amazonaws.com'
        AWS_REGION = 'ap-northeast-2'
        IMAGE_NAME = 'alphacar/frontend'
        SERVICE_NAME = 'frontend'

        // Argo CD ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì €ì¥ì†Œ
        MANIFEST_REPO_URL = 'https://github.com/pogiri1207-a11y/last-alphacar.git'

        GIT_CREDENTIAL_ID = 'github-cred'
        SONAR_TOKEN_CREDENTIAL_ID = 'sonar-token'
    }

    stages {
        stage('0. Check Changes') {
            steps {
                script {
                    // ë””ìŠ¤í¬ ê³µê°„ í™•ì¸ë§Œ ìˆ˜í–‰ (ì •ë¦¬ëŠ” ë³„ë„ ìŠ¤ì¼€ì¤„ëŸ¬ì—ì„œ ì²˜ë¦¬)
                    sh """
                        echo "ğŸ“Š ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸:"
                        USAGE=\$(df / | tail -1 | awk '{print \$5}' | sed 's/%//')
                        echo "ğŸ’¾ ë””ìŠ¤í¬ ì‚¬ìš©ë¥ : \${USAGE}%"
                        # ë””ìŠ¤í¬ ì •ë¦¬ëŠ” ë³„ë„ ìŠ¤ì¼€ì¤„ëŸ¬ì—ì„œ ì²˜ë¦¬
                    """
                    cleanWs()
                    
                    // Git ì²´í¬ì•„ì›ƒ ì¬ì‹œë„ ë¡œì§
                    retry(3) {
                        try {
                            checkout scm
                        } catch (Exception e) {
                            echo "âš ï¸ Git ì²´í¬ì•„ì›ƒ ì‹¤íŒ¨, ì¬ì‹œë„ ì¤‘... ${e.getMessage()}"
                            sleep(time: 2, unit: 'SECONDS')
                            throw e
                        }
                    }
                    
                    echo "ğŸ” ë³€ê²½ëœ íŒŒì¼ í™•ì¸ ì¤‘..."
                    
                    // [skip ci] ì»¤ë°‹ ì²´í¬
                    def commitMessage = sh(script: 'git log -1 --pretty=%B', returnStdout: true).trim()
                    echo "ì»¤ë°‹ ë©”ì‹œì§€: ${commitMessage}"
                    
                    if (commitMessage.contains('[skip ci]')) {
                        echo "â­ï¸ [skip ci] ì»¤ë°‹ ê°ì§€ - ë¹Œë“œë¥¼ ìŠ¤í‚µí•©ë‹ˆë‹¤."
                        currentBuild.result = 'SUCCESS'
                        currentBuild.displayName = "#${currentBuild.number} (Skipped - [skip ci])"
                        return
                    }
                    
                    // ë³€ê²½ íŒŒì¼ í™•ì¸
                    def changedFiles = sh(script: 'git diff --name-only HEAD~1 HEAD 2>/dev/null || echo ""', returnStdout: true).trim()
                    
                    // ë³€ê²½ íŒŒì¼ì´ ì—†ìœ¼ë©´ ìµœê·¼ 2ê°œ ì»¤ë°‹ ë¹„êµ
                    if (!changedFiles || changedFiles.trim().isEmpty()) {
                        def recentCommits = sh(script: 'git log -2 --pretty=%H', returnStdout: true).trim().split('\n')
                        if (recentCommits.size() >= 2) {
                            changedFiles = sh(script: "git diff --name-only ${recentCommits[1]} ${recentCommits[0]} 2>/dev/null || echo \"\"", returnStdout: true).trim()
                        }
                    }
                    
                    echo "ë³€ê²½ëœ íŒŒì¼:\n${changedFiles}"
                    
                    if (!changedFiles || changedFiles.trim().isEmpty()) {
                        echo "âš ï¸ ë³€ê²½ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
                        currentBuild.result = 'SUCCESS'
                        currentBuild.displayName = "#${currentBuild.number} (Skipped - No changes)"
                        return
                    }
                    
                    // frontend-Jenkinsfile ë³€ê²½ì€ ì¡°ê±´ë¶€ í—ˆìš© ([skip ci]ê°€ ìˆìœ¼ë©´ ìŠ¤í‚µ)
                    def fileList = changedFiles.split('\n')
                    def frontendChanged = false
                    
                    for (file in fileList) {
                        file = file.trim()
                        // Jenkinsfile ë³€ê²½ì€ [skip ci]ê°€ ì—†ì„ ë•Œë§Œ ë¹Œë“œ íŠ¸ë¦¬ê±°
                        if (file.contains('frontend-Jenkinsfile') || file.contains('Jenkinsfile.frontend')) {
                            if (!commitMessage.contains('[skip ci]')) {
                                frontendChanged = true
                                echo "âœ… Jenkinsfile ë³€ê²½ ê°ì§€: ${file} ([skip ci] ì—†ìŒ - ë¹Œë“œ ì§„í–‰)"
                                break
                            } else {
                                echo "â­ï¸ Jenkinsfile ë³€ê²½ ê°ì§€ë˜ì—ˆì§€ë§Œ [skip ci]ë¡œ ì¸í•´ ìŠ¤í‚µ: ${file}"
                                continue
                            }
                        }
                        if (file.contains('dev/alphacar/frontend')) {
                            frontendChanged = true
                            echo "âœ… frontend ê´€ë ¨ ë³€ê²½ ê°ì§€: ${file}"
                            break
                        }
                    }
                    
                    if (!frontendChanged) {
                        echo "â­ï¸ frontend ê²½ë¡œ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. ë¹Œë“œë¥¼ ìŠ¤í‚µí•©ë‹ˆë‹¤."
                        echo "ë³€ê²½ëœ ê²½ë¡œ:\n${changedFiles}"
                        currentBuild.result = 'SUCCESS'
                        currentBuild.displayName = "#${currentBuild.number} (Skipped - No frontend changes)"
                        return
                    }
                    
                    echo "âœ… frontend ë³€ê²½ì‚¬í•­ í™•ì¸ë¨ - ë¹Œë“œ ì§„í–‰"
                }
            }
        }

        stage('1. Prepare & Unit Test & SonarQube') {
            steps {
                script {
                    // ì´ë¯¸ì§€ íƒœê·¸ìš© Git SHA ì¶”ì¶œ
                    env.GIT_SHA = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    
                    // ë¹Œë“œ ë²ˆí˜¸ ê´€ë¦¬ (build-number.txt íŒŒì¼ ì‚¬ìš©)
                    def buildNumberPath = 'dev/alphacar/frontend/build-number.txt'
                    def buildNumber = 1
                    
                    try {
                        if (fileExists(buildNumberPath)) {
                            def buildNumberStr = readFile(buildNumberPath).trim()
                            buildNumber = buildNumberStr.toInteger()
                        }
                    } catch (e) {
                        echo "âš ï¸ build-number.txt ì½ê¸° ì‹¤íŒ¨ â†’ 1ë¶€í„° ì‹œì‘"
                    }
                    
                    // ë¹Œë“œ ë²ˆí˜¸ ì¦ê°€
                    buildNumber = buildNumber + 1
                    
                    // ì¦ê°€ëœ ë¹Œë“œ ë²ˆí˜¸ë¥¼ íŒŒì¼ì— ì €ì¥
                    dir('dev/alphacar/frontend') {
                        writeFile file: 'build-number.txt', text: "${buildNumber}"
                        sh "git add build-number.txt || true"
                    }
                    
                    // ë²„ì „ í˜•ì‹: 1.{ì¦ê°€í•˜ëŠ”ìˆ«ì}.0-{GIT_SHA}
                    env.FULL_VERSION = "1.${buildNumber}.0-${env.GIT_SHA}"
                    echo "ğŸ“¦ ë¹Œë“œ ë²„ì „: ${env.FULL_VERSION}"
                }
                // Docker ì»¨í…Œì´ë„ˆì—ì„œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° SonarQube ë¶„ì„
                dir('dev/alphacar/frontend') {
                    script {
                        echo "ğŸ³ Docker ì»¨í…Œì´ë„ˆì—ì„œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
                        
                        // NPM ìºì‹œ ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
                        sh """
                            mkdir -p /var/lib/jenkins/.npm || true
                            chown -R jenkins:jenkins /var/lib/jenkins/.npm 2>/dev/null || sudo chown -R jenkins:jenkins /var/lib/jenkins/.npm || true
                            echo "ğŸ“¦ NPM ìºì‹œ ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì™„ë£Œ"
                        """
                        
                        // Dockerë¥¼ ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (NPM ìºì‹œ í™œìš©ìœ¼ë¡œ ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•)
                        // í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨í•´ë„ ë¹Œë“œ ê³„ì† ì§„í–‰ (ì»¤ë²„ë¦¬ì§€ 0%ì—¬ë„ í†µê³¼ ê°€ëŠ¥)
                        sh """
                            docker run --rm \\
                                -v /var/lib/jenkins/.npm:/.npm \\
                                -v \$(pwd):/app \\
                                -w /app \\
                                node:20-alpine \\
                                sh -c "
                                    npm config set cache /.npm --global && \\
                                    npm install --legacy-peer-deps && \\
                                    npm test -- --watchAll=false --coverage || echo 'âš ï¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨ ë˜ëŠ” í…ŒìŠ¤íŠ¸ ì—†ìŒ - ë¹Œë“œ ê³„ì† ì§„í–‰'
                                " || echo 'âš ï¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨ - ë¹Œë“œ ê³„ì† ì§„í–‰'
                        """
                        
                        // ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ í™•ì¸ ë° ìƒì„± (ì‹¤íŒ¨í•´ë„ ë¹Œë“œ ê³„ì† ì§„í–‰)
                        sh """
                            echo "ğŸ“Š ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ í™•ì¸ ì¤‘..."
                            
                            if [ -f coverage/lcov.info ]; then
                                FILE_SIZE=\$(wc -c < coverage/lcov.info)
                                echo "âœ… coverage/lcov.info íŒŒì¼ ì¡´ì¬ (í¬ê¸°: \$FILE_SIZE bytes)"
                                if [ \$FILE_SIZE -gt 0 ]; then
                                    echo "ğŸ“„ íŒŒì¼ ì²« 30ì¤„:"
                                    head -30 coverage/lcov.info || echo "íŒŒì¼ ì½ê¸° ì‹¤íŒ¨"
                                fi
                            else
                                echo "âš ï¸ coverage/lcov.info íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤ - ë¹ˆ ë¦¬í¬íŠ¸ ìƒì„±"
                                mkdir -p coverage
                                # ë¹ˆ lcov.info íŒŒì¼ ìƒì„± (ìµœì†Œ í˜•ì‹ìœ¼ë¡œ 0% ì»¤ë²„ë¦¬ì§€ í‘œì‹œ)
                                echo "TN:" > coverage/lcov.info
                                echo "end_of_record" >> coverage/lcov.info
                                echo "âœ… ë¹ˆ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ"
                            fi
                            
                            echo "ğŸ” lib ë””ë ‰í† ë¦¬: \$(ls lib/ 2>/dev/null | wc -l) files"
                        """
                        sh "ls -la coverage/ 2>/dev/null || echo 'âš ï¸ coverage ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤'"
                    }
                    
                    // SonarQube ìŠ¤ìº” (withSonarQubeEnv ë¸”ë¡ ë°–ì—ì„œ tool ì„¤ì •)
                    script {
                        try {
                            def sonarPath = tool name: 'sonar-scanner', type: 'hudson.plugins.sonar.SonarRunnerInstallation'
                            env.PATH = "${sonarPath}/bin:${env.PATH}"
                        } catch (Exception e) {
                            error "âŒ SonarQube Scanner ë„êµ¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¹Œë“œë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
                        }
                    }
                    
                    // SonarQube ìŠ¤ìº” (withSonarQubeEnvì™€ withCredentials í•¨ê»˜ ì‚¬ìš©)
                    withSonarQubeEnv('sonarqube') {
                        withCredentials([string(credentialsId: "${env.SONAR_TOKEN_CREDENTIAL_ID}", variable: 'SONAR_TOKEN')]) {
                            script {
                                sh """
                                    echo "ğŸ” SonarQube ìŠ¤ìº” ì‹œì‘..."
                                    echo "â„¹ï¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ëŠ” ì „ë‹¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (ì»¤ë²„ë¦¬ì§€ 0%ì—¬ë„ í†µê³¼ ê°€ëŠ¥)"

                                    echo "ğŸ”‘ SonarQube ì¸ì¦ ì •ë³´ í™•ì¸ ì¤‘..."
                                    if [ -n "\${SONAR_TOKEN}" ]; then
                                        echo "âœ… SonarQube í† í°ì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
                                    else
                                        echo "âŒ SonarQube í† í°ì´ í™˜ê²½ ë³€ìˆ˜ì— ì—†ìŠµë‹ˆë‹¤"
                                        exit 1
                                    fi

                                    echo "ğŸŒ SonarQube í˜¸ìŠ¤íŠ¸ URL: \${SONAR_HOST_URL:-not set}"
                                    
                                    # ì‹¤ì œ ì„œë¹„ìŠ¤ íŒŒì¼ë§Œ í¬í•¨ (lib/api.ts)
                                    SOURCES="lib"
                                    echo "ğŸ“ ë¶„ì„í•  ì†ŒìŠ¤ ë””ë ‰í† ë¦¬: \${SOURCES} (ì‹¤ì œ ì„œë¹„ìŠ¤ íŒŒì¼ë§Œ)"
                                    if grep -q "^sonar.host.url=" sonar-project.properties 2>/dev/null; then
                                        echo "âš ï¸ sonar-project.propertiesì— sonar.host.urlì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì£¼ì„ ì²˜ë¦¬í•˜ì„¸ìš”."
                                        sed -i 's/^sonar.host.url=/#sonar.host.url=/' sonar-project.properties || true
                                    fi

                                    echo "ğŸš€ SonarQube ë¹ ë¥¸ ìŠ¤ìº” ì‹œì‘..."
                                    
                                    # ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ í™•ì¸
                                    
                                    # ë¹ ë¥¸ ìŠ¤ìº”ì„ ìœ„í•œ ìµœì í™”ëœ ì„¤ì •
                                    # baseline-browser-mapping ê²½ê³  ë©”ì‹œì§€ í•„í„°ë§ (ë¹Œë“œì—ëŠ” ì˜í–¥ ì—†ìŒ)
                                    # ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì „ë‹¬í•˜ì§€ ì•ŠìŒ (ì»¤ë²„ë¦¬ì§€ 0%ì—¬ë„ í†µê³¼ ê°€ëŠ¥)
                                    sonar-scanner \\
                                        -Dsonar.projectKey=alphacar-frontend \\
                                        -Dsonar.sources=lib,app \\
                                        -Dsonar.sourceEncoding=UTF-8 \\
                                        -Dsonar.exclusions=**/*.css,**/*.test.*,**/*.spec.*,**/__tests__/**,**/node_modules/**,**/.next/** \\
                                        -Dsonar.coverage.exclusions=**/app/**,**/components/**,**/pages/**,**/*.test.*,**/*.spec.*,**/__tests__/** \\
                                        -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \\
                                        -Dsonar.cpd.exclusions=**/* \\
                                        -Dsonar.javascript.analyzer.maxFileSize=500 \\
                                        -Dsonar.token=\${SONAR_TOKEN} \\
                                        -Dsonar.host.url=\${SONAR_HOST_URL} \\
                                        2>&1 | grep -v "baseline-browser-mapping" | tee /tmp/sonar-scan.log || true
                                    
                                    # sonar-scannerì˜ ì‹¤ì œ exit code í™•ì¸ (report-task.txt íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ë¡œ íŒë‹¨)
                                    SCAN_EXIT_CODE=0
                                    if [ -f ".scannerwork/report-task.txt" ]; then
                                        SCAN_EXIT_CODE=0
                                    else
                                        # report-task.txtê°€ ì—†ìœ¼ë©´ ìŠ¤ìº” ì‹¤íŒ¨ë¡œ ê°„ì£¼
                                        SCAN_EXIT_CODE=1
                                    fi
                                    if [ \$SCAN_EXIT_CODE -eq 0 ]; then
                                        echo "âœ… SonarQube ìŠ¤ìº” ì„±ê³µ!"
                                    else
                                        echo "âŒ SonarQube ìŠ¤ìº” ì‹¤íŒ¨ (ì¢…ë£Œ ì½”ë“œ: \$SCAN_EXIT_CODE)"
                                        echo "ë¹Œë“œë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
                                        exit \$SCAN_EXIT_CODE
                                    fi
                                """
                                
                                // SonarQube Quality Gate ê²°ê³¼ ëŒ€ê¸° ë° ìŠ¬ë™ ì•Œë¦¼ (SonarQube API ì§ì ‘ í˜¸ì¶œ)
                                echo "â³ SonarQube Quality Gate ê²°ê³¼ ëŒ€ê¸° ì¤‘..."
                                timeout(time: 5, unit: 'MINUTES') {
                                    script {
                                        // report-task.txt íŒŒì¼ì—ì„œ task ID ì¶”ì¶œ
                                        def reportTaskFile = '.scannerwork/report-task.txt'
                                        if (!fileExists(reportTaskFile)) {
                                            error "âŒ SonarQube report-task.txt íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                                        }
                                        
                                        def reportTaskContent = readFile(reportTaskFile)
                                        
                                        // ceTaskId ì§ì ‘ ì¶”ì¶œ (ë” ì•ˆì •ì )
                                        def ceTaskId = reportTaskContent.split('\n').find { it.startsWith('ceTaskId=') }?.split('=')[1]?.trim()
                                        
                                        // ë˜ëŠ” ceTaskUrlì—ì„œ task ID ì¶”ì¶œ
                                        if (!ceTaskId) {
                                            def ceTaskUrl = reportTaskContent.split('\n').find { it.startsWith('ceTaskUrl=') }?.split('=')[1]?.trim()
                                            if (ceTaskUrl) {
                                                // URLì—ì„œ task ID ì¶”ì¶œ: http://.../api/ce/task?id=xxxxx
                                                ceTaskId = ceTaskUrl.split('id=')[1]?.split('&')[0]?.trim()
                                            }
                                        }
                                        
                                        if (!ceTaskId) {
                                            error "âŒ ceTaskIdë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                                        }
                                        
                                        echo "ğŸ“‹ Task ID: ${ceTaskId}"
                                        
                                        // SonarQube ì„œë²„ê°€ ë¶„ì„ì„ ì™„ë£Œí•  ë•Œê¹Œì§€ ëŒ€ê¸°
                                        def maxAttempts = 60
                                        def attempt = 0
                                        def qgStatus = null
                                        def sonarHostUrl = env.SONAR_HOST_URL ?: 'http://13.125.43.164:9000'
                                        
                                        while (attempt < maxAttempts) {
                                            sleep(5) // 5ì´ˆ ëŒ€ê¸°
                                            attempt++
                                            
                                            // Task ìƒíƒœ í™•ì¸ (task ID ì‚¬ìš©)
                                            def taskStatus = sh(
                                                script: """
                                                    TASK_RESPONSE=\$(curl -s -u \${SONAR_TOKEN}: '${sonarHostUrl}/api/ce/task?id=${ceTaskId}')
                                                    if command -v jq >/dev/null 2>&1; then
                                                        echo "\$TASK_RESPONSE" | jq -r '.task.status' 2>/dev/null || echo ''
                                                    else
                                                        echo "\$TASK_RESPONSE" | grep -o '"status":"[^"]*"' | head -1 | cut -d'"' -f4 || echo ''
                                                    fi
                                                """,
                                                returnStdout: true
                                            ).trim()
                                            
                                            echo "ğŸ“Š Task ìƒíƒœ (ì‹œë„ ${attempt}/${maxAttempts}): ${taskStatus}"
                                            
                                            // Taskê°€ FAILEDì¸ ê²½ìš° Slack ì•Œë¦¼ í›„ ì—ëŸ¬ ì²˜ë¦¬
                                            if (taskStatus == 'FAILED') {
                                                echo "âŒ SonarQube ë¶„ì„ ì‘ì—… ì‹¤íŒ¨"
                                                try {
                                                    slackSend(
                                                        color: 'danger',
                                                        message: "âŒ *SonarQube ë¶„ì„ ì‘ì—… ì‹¤íŒ¨*\ní”„ë¡œì íŠ¸: ${env.JOB_NAME} [${env.BUILD_NUMBER}]\nì†Œë‚˜íë¸Œ ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸í•˜ì„¸ìš”.\në§í¬: ${sonarHostUrl}/dashboard?id=alphacar-frontend"
                                                    )
                                                } catch (Exception e) {
                                                    echo "âš ï¸ Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: ${e.getMessage()}"
                                                }
                                                error "SonarQube ë¶„ì„ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì†Œë‚˜íë¸Œ ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸í•˜ì„¸ìš”: ${sonarHostUrl}/dashboard?id=alphacar-frontend"
                                            }
                                            
                                            if (taskStatus == 'SUCCESS' || taskStatus == 'CANCELED') {
                                                // analysisId ì¶”ì¶œ
                                                def analysisId = sh(
                                                    script: """
                                                        TASK_RESPONSE=\$(curl -s -u \${SONAR_TOKEN}: '${sonarHostUrl}/api/ce/task?id=${ceTaskId}')
                                                        if command -v jq >/dev/null 2>&1; then
                                                            echo "\$TASK_RESPONSE" | jq -r '.task.analysisId' 2>/dev/null || echo ''
                                                        else
                                                            echo "\$TASK_RESPONSE" | grep -o '"analysisId":"[^"]*"' | head -1 | cut -d'"' -f4 || echo ''
                                                        fi
                                                    """,
                                                    returnStdout: true
                                                ).trim()
                                                
                                                if (analysisId && analysisId != 'null' && analysisId != '') {
                                                    // Quality Gate ìƒíƒœ í™•ì¸
                                                    def qgUrl = "${sonarHostUrl}/api/qualitygates/project_status?analysisId=${analysisId}"
                                                    def qgResponse = sh(
                                                        script: """
                                                            curl -s -u \${SONAR_TOKEN}: '${qgUrl}'
                                                        """,
                                                        returnStdout: true
                                                    ).trim()
                                                    
                                                    qgStatus = sh(
                                                        script: """
                                                            echo '${qgResponse}' | jq -r '.projectStatus.status' 2>/dev/null || echo '${qgResponse}' | grep -o '"status":"[^"]*"' | head -1 | cut -d'"' -f4 || echo ''
                                                        """,
                                                        returnStdout: true
                                                    ).trim()
                                                    
                                                    // Quality Gate ì‹¤íŒ¨ ì›ì¸ ìƒì„¸ ì¶œë ¥
                                                    if (qgStatus != 'OK') {
                                                        echo "âŒ Quality Gate ì‹¤íŒ¨ ìƒì„¸ ì •ë³´:"
                                                        sh """
                                                            echo '${qgResponse}' | jq -r '.projectStatus.conditions[] | select(.status != "OK") | "  - " + .metricKey + ": " + .status + " (í˜„ì¬: " + (.actualValue // "N/A") + ", ìš”êµ¬: " + (.errorThreshold // "N/A") + ")"' 2>/dev/null || echo 'ìƒì„¸ ì •ë³´ í™•ì¸ ë¶ˆê°€'
                                                        """
                                                    }
                                                    
                                                    echo "âœ… Quality Gate ìƒíƒœ: ${qgStatus}"
                                                    break
                                                }
                                            }
                                        }
                                        
                                        if (qgStatus == null) {
                                            // íƒ€ì„ì•„ì›ƒì¸ ê²½ìš°ì—ë„ Slack ì•Œë¦¼ ì „ì†¡
                                            try {
                                                slackSend(
                                                    color: 'warning',
                                                    message: "âš ï¸ *SonarQube Quality Gate ìƒíƒœ í™•ì¸ ì‹¤íŒ¨*\ní”„ë¡œì íŠ¸: ${env.JOB_NAME} [${env.BUILD_NUMBER}]\níƒ€ì„ì•„ì›ƒ ë°œìƒ\në§í¬: ${sonarHostUrl}/dashboard?id=alphacar-frontend"
                                                )
                                            } catch (Exception e) {
                                                echo "âš ï¸ Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: ${e.getMessage()}"
                                            }
                                            error "âŒ Quality Gate ìƒíƒœë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (íƒ€ì„ì•„ì›ƒ)"
                                        }
                                        
                                        // ìŠ¬ë™ ì•Œë¦¼ ì „ì†¡
                                        try {
                                            if (qgStatus != 'OK') {
                                                // í’ˆì§ˆ ê¸°ì¤€ ì‹¤íŒ¨ ì‹œ (ë¹¨ê°„ìƒ‰ ì•Œë¦¼)
                                                slackSend(
                                                    color: 'danger',
                                                    message: "âŒ *SonarQube í’ˆì§ˆ ê²€ì‚¬ ì‹¤íŒ¨*\ní”„ë¡œì íŠ¸: ${env.JOB_NAME} [${env.BUILD_NUMBER}]\nê²°ê³¼: ${qgStatus}\në§í¬: ${sonarHostUrl}/dashboard?id=alphacar-frontend"
                                                )
                                                error "Pipeline aborted due to quality gate failure: ${qgStatus}"
                                            } else {
                                                // í’ˆì§ˆ ê¸°ì¤€ í†µê³¼ ì‹œ (ì´ˆë¡ìƒ‰ ì•Œë¦¼)
                                                slackSend(
                                                    color: 'good',
                                                    message: "âœ… *SonarQube í’ˆì§ˆ ê²€ì‚¬ í†µê³¼*\ní”„ë¡œì íŠ¸: ${env.JOB_NAME} [${env.BUILD_NUMBER}]\nì´ì œ ArgoCD ë°°í¬ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤!"
                                                )
                                            }
                                        } catch (Exception e) {
                                            echo "âš ï¸ Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: ${e.getMessage()}"
                                            // Slack ì•Œë¦¼ ì‹¤íŒ¨í•´ë„ ë¹Œë“œëŠ” ê³„ì† ì§„í–‰
                                            if (qgStatus != 'OK') {
                                                error "Pipeline aborted due to quality gate failure: ${qgStatus}"
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        stage('2. Build & Push to ECR') {
            steps {
                script {
                    echo "ğŸ”¨ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹œì‘ (ê²½ë¡œ: dev/alphacar/frontend)"

                    // Dockerfileì´ ìˆëŠ” ì‹¤ì œ ê²½ë¡œë¡œ ì´ë™í•˜ì—¬ ë¹Œë“œ ë° í‘¸ì‹œ
                    dir('dev/alphacar/frontend') {
                        def imageFullTag = "${ECR_REGISTRY}/${IMAGE_NAME}:${env.FULL_VERSION}"
                        echo "ğŸ³ ë„ì»¤ ë¹Œë“œ ì‹œì‘: ${imageFullTag}"
                        
                        // Docker ë¹Œë“œ íƒ€ì„ì•„ì›ƒ ì„¤ì • (30ë¶„)
                        timeout(time: 30, unit: 'MINUTES') {
                            // Docker ë¹Œë“œ (ìºì‹œ ë¬¸ì œ ë°œìƒ ì‹œ ì¬ì‹œë„)
                            // ì‹œì—°ìš©: ë”ë¯¸ ì¹´ì¹´ì˜¤ API í‚¤ ì‚¬ìš© (SonarQube í…ŒìŠ¤íŠ¸ìš©)
                            def kakaoRestApiKey = "dummy_kakao_rest_api_key_for_sonarqube_test_12345"
                            def kakaoMapApiKey = "dummy_kakao_map_api_key_for_sonarqube_test_12345"
                            
                            def buildSuccess = false
                            try {
                                // ë¨¼ì € ìºì‹œë¥¼ í™œìš©í•˜ì—¬ ë¹Œë“œ ì‹œë„
                                sh """
                                    docker build \\
                                        -f Dockerfile \\
                                        -t ${imageFullTag} \\
                                        --cache-from ${ECR_REGISTRY}/${IMAGE_NAME}:latest \\
                                        --build-arg NEXT_PUBLIC_KAKAO_REST_API_KEY=${kakaoRestApiKey} \\
                                        --build-arg NEXT_PUBLIC_KAKAO_MAP_API_KEY=${kakaoMapApiKey} \\
                                        .
                                """
                                buildSuccess = true
                            } catch (Exception e) {
                                echo "âš ï¸ ìºì‹œë¥¼ ì‚¬ìš©í•œ ë¹Œë“œ ì‹¤íŒ¨, ìºì‹œ ì—†ì´ ì¬ì‹œë„í•©ë‹ˆë‹¤..."
                                // ìºì‹œ ì—†ì´ ì¬ì‹œë„
                                sh """
                                    docker build \\
                                        -f Dockerfile \\
                                        -t ${imageFullTag} \\
                                        --no-cache \\
                                        --build-arg NEXT_PUBLIC_KAKAO_REST_API_KEY=${kakaoRestApiKey} \\
                                        --build-arg NEXT_PUBLIC_KAKAO_MAP_API_KEY=${kakaoMapApiKey} \\
                                        .
                                """
                                buildSuccess = true
                            }
                            
                            if (!buildSuccess) {
                                error "âŒ Docker ë¹Œë“œ ì‹¤íŒ¨"
                            }
                        }

                        // AWS ECR ë¡œê·¸ì¸
                        script {
                            def awsPath = sh(script: 'which aws || echo /usr/local/bin/aws', returnStdout: true).trim()
                            if (!awsPath || !fileExists(awsPath)) {
                                error "AWS CLI not found. Please install AWS CLI on the Jenkins server."
                            }
                            sh """
                                ${awsPath} ecr get-login-password --region ${AWS_REGION} | \\
                                docker login --username AWS --password-stdin ${ECR_REGISTRY}
                            """
                        }
                        
                        sh "docker push ${imageFullTag}"
                        sh "docker logout ${ECR_REGISTRY}"
                        
                        echo "âœ… ECR í‘¸ì‹œ ì™„ë£Œ: ${imageFullTag}"
                    }
                }
            }
        }

        stage('3. Update Manifests (GitOps)') {
            steps {
                script {
                    echo "ğŸš€ [GitOps] í”„ë¡ íŠ¸ì—”ë“œ Manifest ì—…ë°ì´íŠ¸ ì‹œì‘"
                    
                    // í˜„ì¬ ì €ì¥ì†Œì˜ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ ì§ì ‘ ì—…ë°ì´íŠ¸
                    def yamlPath = "k8s/frontend/frontend-deployment-multimaster.yaml"
                    def imageFullTag = "${ECR_REGISTRY}/${IMAGE_NAME}:${env.FULL_VERSION}"

                    // íŒŒì¼ ì¡´ì¬ í™•ì¸
                    if (!fileExists(yamlPath)) {
                        error "âŒ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${yamlPath}"
                    }

                    // Git ì»¤ë°‹ ë° í‘¸ì‹œ
                    withCredentials([usernamePassword(credentialsId: "${env.GIT_CREDENTIAL_ID}", usernameVariable: 'GITHUB_USER', passwordVariable: 'GITHUB_TOKEN')]) {
                        sh """
                            git config user.email "jenkins@alphacar.com"
                            git config user.name "Jenkins-CI"
                            
                            # í˜„ì¬ ë¸Œëœì¹˜ í™•ì¸
                            CURRENT_BRANCH=\$(git rev-parse --abbrev-ref HEAD)
                            echo "í˜„ì¬ ë¸Œëœì¹˜: \${CURRENT_BRANCH}"
                            
                            # detached HEAD ìƒíƒœì¸ ê²½ìš° main ë¸Œëœì¹˜ë¡œ checkout
                            if [ "\${CURRENT_BRANCH}" = "HEAD" ]; then
                                echo "âš ï¸ Detached HEAD ìƒíƒœ ê°ì§€ - main ë¸Œëœì¹˜ë¡œ ì „í™˜"
                                # ì›ê²© main ë¸Œëœì¹˜ë¥¼ ì¶”ì í•˜ëŠ” ë¡œì»¬ ë¸Œëœì¹˜ ìƒì„±
                                git fetch https://\${GITHUB_TOKEN}@github.com/Alphacar-project/alphacar-k8s.git main:main || true
                                git checkout main || {
                                    echo "âš ï¸ main ë¸Œëœì¹˜ checkout ì‹¤íŒ¨ - ìƒˆë¡œ ìƒì„±"
                                    git checkout -b main
                                    git branch --set-upstream-to=origin/main main || true
                                }
                            fi
                            
                            # ì›ê²© ì €ì¥ì†Œì˜ ìµœì‹  ë³€ê²½ì‚¬í•­ ê°€ì ¸ì˜¤ê¸° (íŒŒì¼ ìˆ˜ì • ì „ì— ë¨¼ì € pull)
                            echo "ğŸ“¥ ì›ê²© ì €ì¥ì†Œ ìµœì‹  ë³€ê²½ì‚¬í•­ ê°€ì ¸ì˜¤ê¸°..."
                            git fetch https://\${GITHUB_TOKEN}@github.com/Alphacar-project/alphacar-k8s.git main || true
                            git pull --rebase https://\${GITHUB_TOKEN}@github.com/Alphacar-project/alphacar-k8s.git main || {
                                echo "âš ï¸ Rebase ì‹¤íŒ¨ - merge ì‹œë„"
                                git pull --no-rebase https://\${GITHUB_TOKEN}@github.com/Alphacar-project/alphacar-k8s.git main || true
                            }
                            
                            echo "ğŸ“ [ìë™í™”] ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ${imageFullTag}ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."
                            
                            # ECR ì´ë¯¸ì§€ ê²½ë¡œë¡œ ì—…ë°ì´íŠ¸
                            sed -i 's|image: .*/alphacar.*frontend.*:.*|image: ${imageFullTag}|' ${yamlPath}
                            
                            # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ ì—…ë°ì´íŠ¸
                            git add ${yamlPath}
                            
                            # ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹ ë° í‘¸ì‹œ
                            if [ -n "\$(git status --porcelain)" ]; then
                                git commit -m "Update frontend image to ${env.FULL_VERSION} [skip ci]"
                                echo "âœ… ë¡œì»¬ ì»¤ë°‹ ì™„ë£Œ"
                                
                                # í˜„ì¬ ë¸Œëœì¹˜ ì´ë¦„ í™•ì¸
                                BRANCH_NAME=\$(git rev-parse --abbrev-ref HEAD)
                                echo "í‘¸ì‹œí•  ë¸Œëœì¹˜: \${BRANCH_NAME}"
                                
                                # í† í°ì„ URLì— í¬í•¨ì‹œì¼œ ì¸ì¦ ì˜¤ë¥˜(128)ë¥¼ í•´ê²°í•©ë‹ˆë‹¤.
                                git push https://\${GITHUB_TOKEN}@github.com/Alphacar-project/alphacar-k8s.git \${BRANCH_NAME}:main
                                echo "ğŸš€ ê¹ƒí—ˆë¸Œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ë° í‘¸ì‹œ ì„±ê³µ!"
                            else
                                echo "âœ… ë³€ê²½ì‚¬í•­ ì—†ìŒ (ì´ë¯¸ ìµœì‹  ìƒíƒœì…ë‹ˆë‹¤)"
                            fi
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                sh """
                    echo "ğŸ“Š ë¹Œë“œ í›„ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸..."
                    USAGE=\$(df / | tail -1 | awk '{print \$5}' | sed 's/%//')
                    echo "ğŸ’¾ í˜„ì¬ ë””ìŠ¤í¬ ì‚¬ìš©ë¥ : \${USAGE}%"
                    
                    if [ \${USAGE} -gt 80 ]; then
                        echo "âš ï¸ ë””ìŠ¤í¬ ë¶€ì¡±(\${USAGE}%)ìœ¼ë¡œ ì¸í•´ ì„ íƒì  ì •ë¦¬ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤."
                        
                        # 24ì‹œê°„ ì´ìƒ ëœ ì´ë¯¸ì§€ë§Œ ì‚­ì œ (ìµœê·¼ ì´ë¯¸ì§€ëŠ” ë³´ì¡´)
                        docker image prune -a -f --filter "until=24h" || true
                        
                        # ì¤‘ì§€ëœ ì»¨í…Œì´ë„ˆë§Œ ì‚­ì œ
                        docker container prune -f || true
                        
                        # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë³¼ë¥¨ë§Œ ì‚­ì œ
                        docker volume prune -f || true
                        
                        # ë¹Œë” ìºì‹œëŠ” ìœ ì§€ (ë¹Œë“œ ì†ë„ì— ì¤‘ìš”)
                        # docker builder prune -f  # ì£¼ì„ ì²˜ë¦¬
                        
                        echo "âœ… ì„ íƒì  ì •ë¦¬ ì™„ë£Œ"
                    else
                        echo "âœ… ë””ìŠ¤í¬ ì—¬ìœ  ê³µê°„ ì¶©ë¶„(\${USAGE}%) - ì •ë¦¬ ìŠ¤í‚µ (ìºì‹œ ë³´ì¡´)"
                    fi
                    
                    echo "ğŸ“Š ìµœì¢… ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
                    df -h
                """
                cleanWs()
            }
        }
    }
}
