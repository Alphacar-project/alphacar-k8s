pipeline {
    agent any

    environment {
        ECR_REGISTRY = '382045063773.dkr.ecr.ap-northeast-2.amazonaws.com'
        AWS_REGION = 'ap-northeast-2'
        IMAGE_NAME = 'alphacar/frontend'
        SERVICE_NAME = 'frontend'

        // Argo CD ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì €ì¥ì†Œ
        MANIFEST_REPO_URL = 'https://github.com/pogiri1207-a11y/last-alphacar.git'

        GIT_CREDENTIAL_ID = 'github-cred'
        SONAR_TOKEN_CREDENTIAL_ID = 'sonar-token'
    }

    stages {
        stage('0. Check Changes') {
            steps {
                script {
                    cleanWs()
                    checkout scm
                    
                    echo "ğŸ” ë³€ê²½ëœ íŒŒì¼ í™•ì¸ ì¤‘..."
                    
                    // [skip ci] ì»¤ë°‹ ì²´í¬
                    def commitMessage = sh(script: 'git log -1 --pretty=%B', returnStdout: true).trim()
                    echo "ì»¤ë°‹ ë©”ì‹œì§€: ${commitMessage}"
                    
                    if (commitMessage.contains('[skip ci]')) {
                        echo "â­ï¸ [skip ci] ì»¤ë°‹ ê°ì§€ - ë¹Œë“œë¥¼ ìŠ¤í‚µí•©ë‹ˆë‹¤."
                        currentBuild.result = 'SUCCESS'
                        currentBuild.displayName = "#${currentBuild.number} (Skipped - [skip ci])"
                        return
                    }
                    
                    // ë³€ê²½ íŒŒì¼ í™•ì¸
                    def changedFiles = sh(script: 'git diff --name-only HEAD~1 HEAD 2>/dev/null || echo ""', returnStdout: true).trim()
                    
                    // ë³€ê²½ íŒŒì¼ì´ ì—†ìœ¼ë©´ ìµœê·¼ 2ê°œ ì»¤ë°‹ ë¹„êµ
                    if (!changedFiles || changedFiles.trim().isEmpty()) {
                        def recentCommits = sh(script: 'git log -2 --pretty=%H', returnStdout: true).trim().split('\n')
                        if (recentCommits.size() >= 2) {
                            changedFiles = sh(script: "git diff --name-only ${recentCommits[1]} ${recentCommits[0]} 2>/dev/null || echo \"\"", returnStdout: true).trim()
                        }
                    }
                    
                    echo "ë³€ê²½ëœ íŒŒì¼:\n${changedFiles}"
                    
                    if (!changedFiles || changedFiles.trim().isEmpty()) {
                        echo "âš ï¸ ë³€ê²½ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
                        currentBuild.result = 'SUCCESS'
                        currentBuild.displayName = "#${currentBuild.number} (Skipped - No changes)"
                        return
                    }
                    
                    // frontend-Jenkinsfile ë³€ê²½ì€ ë¬´ì‹œí•˜ë˜, ë‹¤ë¥¸ Jenkinsfile ë³€ê²½ì€ í—ˆìš©
                    def fileList = changedFiles.split('\n')
                    def frontendChanged = false
                    
                    for (file in fileList) {
                        file = file.trim()
                        // frontend-Jenkinsfile ë³€ê²½ì€ ë¬´ì‹œ
                        if (file.contains('frontend-Jenkinsfile') || file.contains('Jenkinsfile.frontend')) {
                            continue
                        }
                        if (file.contains('dev/alphacar/frontend')) {
                            frontendChanged = true
                            echo "âœ… frontend ê´€ë ¨ ë³€ê²½ ê°ì§€: ${file}"
                            break
                        }
                    }
                    
                    if (!frontendChanged) {
                        echo "â­ï¸ frontend ê²½ë¡œ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. ë¹Œë“œë¥¼ ìŠ¤í‚µí•©ë‹ˆë‹¤."
                        echo "ë³€ê²½ëœ ê²½ë¡œ:\n${changedFiles}"
                        currentBuild.result = 'SUCCESS'
                        currentBuild.displayName = "#${currentBuild.number} (Skipped - No frontend changes)"
                        return
                    }
                    
                    echo "âœ… frontend ë³€ê²½ì‚¬í•­ í™•ì¸ë¨ - ë¹Œë“œ ì§„í–‰"
                }
            }
        }

        stage('1. Prepare & Unit Test & SonarQube') {
            steps {
                script {
                    // ì´ë¯¸ì§€ íƒœê·¸ìš© Git SHA ì¶”ì¶œ
                    env.GIT_SHA = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    
                    // ë²„ì „ ì •ë³´ ì„¤ì •
                    def baseVer = "1.0"
                    def versionPath = 'dev/alphacar/frontend/version.txt'
                    try {
                        if (fileExists(versionPath)) {
                            baseVer = readFile(versionPath).trim()
                        }
                    } catch (e) {
                        echo "âš ï¸ version.txt ì½ê¸° ì‹¤íŒ¨ â†’ 1.0 ì‚¬ìš©"
                    }
                    env.FULL_VERSION = "${baseVer}.${currentBuild.number}-${env.GIT_SHA}"
                    echo "ğŸ“¦ ë¹Œë“œ ë²„ì „: ${env.FULL_VERSION}"
                }
                // í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° SonarQube ë¶„ì„ (ì‹¤íŒ¨ ì‹œ ë¹Œë“œ ì¤‘ë‹¨)
                dir('dev/alphacar/frontend') {
                    script {
                        // Node.js/npm ê²½ë¡œ í™•ì¸ ë° ì„¤ì •
                        echo "ğŸ” Node.js/npm ê²½ë¡œ ì°¾ëŠ” ì¤‘..."
                        def nodePath = sh(script: 'which node 2>/dev/null || echo ""', returnStdout: true).trim()
                        def npmPath = sh(script: 'which npm 2>/dev/null || echo ""', returnStdout: true).trim()
                        
                        // ì—¬ëŸ¬ ì¼ë°˜ì ì¸ ê²½ë¡œì—ì„œ Node.js ì°¾ê¸°
                        if (!nodePath) {
                            echo "âš ï¸ PATHì—ì„œ Node.jsë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¼ë°˜ì ì¸ ê²½ë¡œì—ì„œ ê²€ìƒ‰ ì¤‘..."
                            nodePath = sh(script: '''
                                for path in /usr/local/bin/node /usr/bin/node /opt/nodejs/bin/node ~/.nvm/versions/node/*/bin/node; do
                                    if [ -f "$path" ] 2>/dev/null; then
                                        echo "$path"
                                        break
                                    fi
                                done
                            ''', returnStdout: true).trim()
                        }
                        
                        // nvmì´ ìˆëŠ” ê²½ìš° ì‚¬ìš© ì‹œë„ (ì—¬ëŸ¬ ì‚¬ìš©ì í™ˆ ë””ë ‰í† ë¦¬ í™•ì¸)
                        if (!nodePath || !npmPath) {
                            echo "âš ï¸ Node.js/npmì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. nvm í™•ì¸ ì¤‘..."
                            echo "í˜„ì¬ ì‚¬ìš©ì: ${env.USER:-unknown}, í™ˆ ë””ë ‰í† ë¦¬: ${env.HOME:-unknown}"
                            
                            // ì—¬ëŸ¬ ì‚¬ìš©ìì˜ nvm ê²½ë¡œ í™•ì¸
                            def nvmCheck = sh(script: '''
                                for nvm_user in ubuntu jenkins ec2-user root; do
                                    for nvm_home in /home/$nvm_user /var/lib/jenkins ~; do
                                        NVM_DIR="$nvm_home/.nvm"
                                        if [ -s "$NVM_DIR/nvm.sh" ]; then
                                            export NVM_DIR
                                            . "$NVM_DIR/nvm.sh"
                                            nvm use default 2>/dev/null || nvm use 20 2>/dev/null || nvm use node 2>/dev/null || true
                                            NODE_PATH=$(which node 2>/dev/null)
                                            if [ -n "$NODE_PATH" ]; then
                                                echo "$NODE_PATH"
                                                exit 0
                                            fi
                                        fi
                                    done
                                done
                                echo ""
                            ''', returnStdout: true).trim()
                            
                            if (nvmCheck) {
                                nodePath = nvmCheck
                                // npm ê²½ë¡œë„ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ì°¾ê¸°
                                npmPath = sh(script: '''
                                    for nvm_user in ubuntu jenkins ec2-user root; do
                                        for nvm_home in /home/$nvm_user /var/lib/jenkins ~; do
                                            NVM_DIR="$nvm_home/.nvm"
                                            if [ -s "$NVM_DIR/nvm.sh" ]; then
                                                export NVM_DIR
                                                . "$NVM_DIR/nvm.sh"
                                                nvm use default 2>/dev/null || nvm use 20 2>/dev/null || nvm use node 2>/dev/null || true
                                                NPM_PATH=$(which npm 2>/dev/null)
                                                if [ -n "$NPM_PATH" ]; then
                                                    echo "$NPM_PATH"
                                                    exit 0
                                                fi
                                            fi
                                        done
                                    done
                                    echo ""
                                ''', returnStdout: true).trim()
                            }
                        }
                        
                        if (!nodePath || !npmPath) {
                            error """
âŒ Node.js/npmì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

Jenkins ì—ì´ì „íŠ¸ì— Node.jsë¥¼ ì„¤ì¹˜í•´ì£¼ì„¸ìš”:

ë°©ë²• 1: nvm ì„¤ì¹˜
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.nvm/nvm.sh
nvm install 20
nvm use 20

ë°©ë²• 2: ì§ì ‘ ì„¤ì¹˜
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

í˜„ì¬ PATH: ${env.PATH}
"""
                        }
                        
                        echo "âœ… Node.js ê²½ë¡œ: ${nodePath}"
                        echo "âœ… npm ê²½ë¡œ: ${npmPath}"
                        
                        // PATHì— Node.js ê²½ë¡œ ì¶”ê°€
                        def nodeBinDir = sh(script: "dirname ${nodePath} 2>/dev/null || echo /usr/local/bin", returnStdout: true).trim()
                        env.PATH = "${nodeBinDir}:${env.PATH}"
                        echo "âœ… PATH ì—…ë°ì´íŠ¸: ${env.PATH}"
                        
                        echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
                        sh "npm install --legacy-peer-deps"
                        
                        echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘..."
                        sh "npm test -- --watchAll=false --coverage || echo 'âš ï¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨ ë˜ëŠ” í…ŒìŠ¤íŠ¸ ì—†ìŒ'"
                        
                        // ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ íŒŒì¼ í™•ì¸
                        sh "ls -la coverage/ 2>/dev/null || echo 'âš ï¸ coverage ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤'"
                        
                        try {
                            def sonarPath = tool name: 'sonar-scanner', type: 'hudson.plugins.sonar.SonarRunnerInstallation'
                            env.PATH = "${sonarPath}/bin:${env.PATH}"
                        } catch (Exception e) {
                            error "âŒ SonarQube Scanner ë„êµ¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¹Œë“œë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
                        }
                    }
                    withSonarQubeEnv('sonarqube') {
                        script {
                            // SonarQube í† í°ê³¼ í˜¸ìŠ¤íŠ¸ URLì´ í™˜ê²½ ë³€ìˆ˜ë¡œ ìë™ ì£¼ì…ë¨ (withSonarQubeEnvê°€ ì²˜ë¦¬)
                            sh """
                                echo "ğŸ” SonarQube ìŠ¤ìº” ì‹œì‘..."
                                echo "ğŸ“Š ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ê²½ë¡œ í™•ì¸:"
                                ls -la coverage/lcov.info 2>/dev/null || echo "âš ï¸ coverage/lcov.info íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"

                                echo "ğŸ”‘ SonarQube ì¸ì¦ ì •ë³´ í™•ì¸ ì¤‘..."
                                if [ -n "\${SONAR_TOKEN}" ]; then
                                    echo "âœ… SonarQube í† í°ì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
                                else
                                    echo "âŒ SonarQube í† í°ì´ í™˜ê²½ ë³€ìˆ˜ì— ì—†ìŠµë‹ˆë‹¤"
                                    exit 1
                                fi

                                echo "ğŸŒ SonarQube í˜¸ìŠ¤íŠ¸ URL: \${SONAR_HOST_URL:-not set}"
                                
                                if [ -z "\${SONAR_HOST_URL}" ]; then
                                    echo "âŒ SonarQube í˜¸ìŠ¤íŠ¸ URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
                                    exit 1
                                fi

                                # sonar-project.properties íŒŒì¼ì—ì„œ host.url ì œê±° í™•ì¸
                                if grep -q "^sonar.host.url=" sonar-project.properties 2>/dev/null; then
                                    echo "âš ï¸ sonar-project.propertiesì— sonar.host.urlì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì£¼ì„ ì²˜ë¦¬í•˜ì„¸ìš”."
                                    sed -i 's/^sonar.host.url=/#sonar.host.url=/' sonar-project.properties || true
                                fi

                                echo "ğŸš€ SonarQube ìŠ¤ìº” ì‹¤í–‰ ì¤‘..."
                                sonar-scanner \\
                                    -Dsonar.projectKey=alphacar-frontend \\
                                    -Dsonar.sources=app,components,lib \\
                                    -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \\
                                    -Dsonar.sourceEncoding=UTF-8

                                SCAN_EXIT_CODE=\$?
                                if [ \$SCAN_EXIT_CODE -eq 0 ]; then
                                    echo "âœ… SonarQube ìŠ¤ìº” ì„±ê³µ!"
                                else
                                    echo "âŒ SonarQube ìŠ¤ìº” ì‹¤íŒ¨ (ì¢…ë£Œ ì½”ë“œ: \$SCAN_EXIT_CODE)"
                                    echo "ë¹Œë“œë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
                                    exit \$SCAN_EXIT_CODE
                                fi
                            """
                        }
                    }
                }
            }
        }

        stage('2. Build & Push to ECR') {
            steps {
                script {
                    echo "ğŸ”¨ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹œì‘ (ê²½ë¡œ: dev/alphacar/frontend)"

                    // Dockerfileì´ ìˆëŠ” ì‹¤ì œ ê²½ë¡œë¡œ ì´ë™í•˜ì—¬ ë¹Œë“œ ë° í‘¸ì‹œ
                    dir('dev/alphacar/frontend') {
                        def imageFullTag = "${ECR_REGISTRY}/${IMAGE_NAME}:${env.FULL_VERSION}"
                        echo "ğŸ³ ë„ì»¤ ë¹Œë“œ ì‹œì‘: ${imageFullTag}"
                        
                        // Docker ë¹Œë“œ íƒ€ì„ì•„ì›ƒ ì„¤ì • (30ë¶„)
                        timeout(time: 30, unit: 'MINUTES') {
                            // Docker ë¹Œë“œ ì „ ìºì‹œ ì •ë¦¬ (í•„ìš”ì‹œ)
                            sh "docker builder prune -f || true"
                            sh "docker build --pull -f Dockerfile -t ${imageFullTag} ."
                        }

                        // AWS ECR ë¡œê·¸ì¸
                        script {
                            def awsPath = sh(script: 'which aws || echo /usr/local/bin/aws', returnStdout: true).trim()
                            if (!awsPath || !fileExists(awsPath)) {
                                error "AWS CLI not found. Please install AWS CLI on the Jenkins server."
                            }
                            sh """
                                ${awsPath} ecr get-login-password --region ${AWS_REGION} | \\
                                docker login --username AWS --password-stdin ${ECR_REGISTRY}
                            """
                        }
                        
                        sh "docker push ${imageFullTag}"
                        sh "docker logout ${ECR_REGISTRY}"
                        
                        echo "âœ… ECR í‘¸ì‹œ ì™„ë£Œ: ${imageFullTag}"
                    }
                }
            }
        }

        stage('3. Update Manifests (GitOps)') {
            steps {
                script {
                    echo "ğŸš€ [GitOps] í”„ë¡ íŠ¸ì—”ë“œ Manifest ì—…ë°ì´íŠ¸ ì‹œì‘"
                    
                    // í˜„ì¬ ì €ì¥ì†Œì˜ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ ì§ì ‘ ì—…ë°ì´íŠ¸
                    def yamlPath = "k8s/frontend/frontend-deployment-multimaster.yaml"
                    def imageFullTag = "${ECR_REGISTRY}/${IMAGE_NAME}:${env.FULL_VERSION}"

                    // íŒŒì¼ ì¡´ì¬ í™•ì¸
                    if (!fileExists(yamlPath)) {
                        error "âŒ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${yamlPath}"
                    }

                    // Git ì»¤ë°‹ ë° í‘¸ì‹œ
                    withCredentials([usernamePassword(credentialsId: "${env.GIT_CREDENTIAL_ID}", usernameVariable: 'GITHUB_USER', passwordVariable: 'GITHUB_TOKEN')]) {
                        sh """
                            git config user.email "jenkins@alphacar.com"
                            git config user.name "Jenkins-CI"
                            
                            # í˜„ì¬ ë¸Œëœì¹˜ í™•ì¸
                            CURRENT_BRANCH=\$(git rev-parse --abbrev-ref HEAD)
                            echo "í˜„ì¬ ë¸Œëœì¹˜: \${CURRENT_BRANCH}"
                            
                            # detached HEAD ìƒíƒœì¸ ê²½ìš° main ë¸Œëœì¹˜ë¡œ checkout
                            if [ "\${CURRENT_BRANCH}" = "HEAD" ]; then
                                echo "âš ï¸ Detached HEAD ìƒíƒœ ê°ì§€ - main ë¸Œëœì¹˜ë¡œ ì „í™˜"
                                # ì›ê²© main ë¸Œëœì¹˜ë¥¼ ì¶”ì í•˜ëŠ” ë¡œì»¬ ë¸Œëœì¹˜ ìƒì„±
                                git fetch https://\${GITHUB_TOKEN}@github.com/Alphacar-project/alphacar-k8s.git main:main || true
                                git checkout main || {
                                    echo "âš ï¸ main ë¸Œëœì¹˜ checkout ì‹¤íŒ¨ - ìƒˆë¡œ ìƒì„±"
                                    git checkout -b main
                                    git branch --set-upstream-to=origin/main main || true
                                }
                            fi
                            
                            # ì›ê²© ì €ì¥ì†Œì˜ ìµœì‹  ë³€ê²½ì‚¬í•­ ê°€ì ¸ì˜¤ê¸° (íŒŒì¼ ìˆ˜ì • ì „ì— ë¨¼ì € pull)
                            echo "ğŸ“¥ ì›ê²© ì €ì¥ì†Œ ìµœì‹  ë³€ê²½ì‚¬í•­ ê°€ì ¸ì˜¤ê¸°..."
                            git fetch https://\${GITHUB_TOKEN}@github.com/Alphacar-project/alphacar-k8s.git main || true
                            git pull --rebase https://\${GITHUB_TOKEN}@github.com/Alphacar-project/alphacar-k8s.git main || {
                                echo "âš ï¸ Rebase ì‹¤íŒ¨ - merge ì‹œë„"
                                git pull --no-rebase https://\${GITHUB_TOKEN}@github.com/Alphacar-project/alphacar-k8s.git main || true
                            }
                            
                            echo "ğŸ“ [ìë™í™”] ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ${imageFullTag}ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."
                            
                            # ECR ì´ë¯¸ì§€ ê²½ë¡œë¡œ ì—…ë°ì´íŠ¸
                            sed -i 's|image: .*/alphacar.*frontend.*:.*|image: ${imageFullTag}|' ${yamlPath}
                            
                            # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ ì—…ë°ì´íŠ¸
                            git add ${yamlPath}
                            
                            # ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹ ë° í‘¸ì‹œ
                            if [ -n "\$(git status --porcelain)" ]; then
                                git commit -m "Update frontend image to ${env.FULL_VERSION} [skip ci]"
                                echo "âœ… ë¡œì»¬ ì»¤ë°‹ ì™„ë£Œ"
                                
                                # í˜„ì¬ ë¸Œëœì¹˜ ì´ë¦„ í™•ì¸
                                BRANCH_NAME=\$(git rev-parse --abbrev-ref HEAD)
                                echo "í‘¸ì‹œí•  ë¸Œëœì¹˜: \${BRANCH_NAME}"
                                
                                # í† í°ì„ URLì— í¬í•¨ì‹œì¼œ ì¸ì¦ ì˜¤ë¥˜(128)ë¥¼ í•´ê²°í•©ë‹ˆë‹¤.
                                git push https://\${GITHUB_TOKEN}@github.com/Alphacar-project/alphacar-k8s.git \${BRANCH_NAME}:main
                                echo "ğŸš€ ê¹ƒí—ˆë¸Œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ë° í‘¸ì‹œ ì„±ê³µ!"
                            else
                                echo "âœ… ë³€ê²½ì‚¬í•­ ì—†ìŒ (ì´ë¯¸ ìµœì‹  ìƒíƒœì…ë‹ˆë‹¤)"
                            fi
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            sh """
                docker image prune -f || true
                docker container prune -f || true
                docker builder prune -f || true
            """
            cleanWs()
        }
    }
}
