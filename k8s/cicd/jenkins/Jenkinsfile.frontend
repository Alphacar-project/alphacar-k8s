pipeline {
    agent any
    parameters {
        choice(name: 'ACTION',
               choices: ['build_and_deploy', 'skip_build'],
               description: 'ÌîÑÎ°†Ìä∏ÏóîÎìú ÎπåÎìú Î∞è Î∞∞Ìè¨Î•º ÏßÑÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?')
        string(name: 'VERSION', defaultValue: '1.0', description: 'Í∏∞Î≥∏ Î≤ÑÏ†Ñ')
        booleanParam(name: 'SKIP_SONAR', defaultValue: false, description: 'SonarQube Î∂ÑÏÑù Ïä§ÌÇµ (ÌÉÄÏûÑÏïÑÏõÉ Î∞úÏÉù Ïãú ÏÇ¨Ïö©)')
    }
    environment {
        ECR_REGISTRY = '382045063773.dkr.ecr.ap-northeast-2.amazonaws.com'
        AWS_REGION = 'ap-northeast-2'
        IMAGE_NAME = 'alphacar/frontend'
        GIT_CREDENTIAL_ID = 'github-cred'
        SONARQUBE_NAME = 'SonarQube'
        SONAR_HOST_URL = 'http://192.168.0.170:32000'
        MANIFEST_REPO_URL = 'https://github.com/Alphacar-project/alphacar-k8s.git'
    }
    stages {
        stage('0. Check Changes') {
            when { expression { params.ACTION == 'build_and_deploy' } }
            steps {
                script {
                    echo "üîç Î≥ÄÍ≤ΩÎêú ÌååÏùº ÌôïÏù∏ Ï§ë..."
                    checkout scm
                    
                    def commitMessage = sh(script: 'git log -1 --pretty=%B', returnStdout: true).trim()
                    if (commitMessage.contains('[skip ci]')) {
                        echo "‚è≠Ô∏è [skip ci] Ïª§Î∞ã Í∞êÏßÄ - ÎπåÎìúÎ•º Ïä§ÌÇµÌï©ÎãàÎã§."
                        currentBuild.result = 'SUCCESS'
                        return
                    }
                    
                    def changedFiles = sh(script: 'git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only origin/main...HEAD 2>/dev/null || echo ""', returnStdout: true).trim()
                    if (!changedFiles) {
                        echo "‚ö†Ô∏è Î≥ÄÍ≤ΩÎêú ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§."
                        currentBuild.result = 'SUCCESS'
                        return
                    }
                    
                    echo "Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù:\n${changedFiles}"
                    
                    def frontendChanged = false
                    def fileList = changedFiles.split('\n')
                    for (file in fileList) {
                        file = file.trim()
                        if (file && file.contains('dev/alphacar/frontend')) {
                            frontendChanged = true
                            echo "‚úÖ frontend Í¥ÄÎ†® Î≥ÄÍ≤Ω Í∞êÏßÄ: ${file}"
                            break
                        }
                    }
                    
                    if (!frontendChanged) {
                        echo "‚è≠Ô∏è frontend Í≤ΩÎ°ú Î≥ÄÍ≤ΩÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§. ÎπåÎìúÎ•º Ïä§ÌÇµÌï©ÎãàÎã§."
                        echo "Î≥ÄÍ≤ΩÎêú Í≤ΩÎ°ú:\n${changedFiles}"
                        currentBuild.result = 'SUCCESS'
                        return
                    }
                    
                    echo "‚úÖ frontend Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÌôïÏù∏Îê® - ÎπåÎìú ÏßÑÌñâ"
                }
            }
        }
        stage('1. Prepare') {
            when { expression { params.ACTION == 'build_and_deploy' } }
            steps {
                script {
                    // Î≥ÄÍ≤Ω Í∞êÏßÄ Ïû¨ÌôïÏù∏
                    checkout scm
                    def commitMessage = sh(script: 'git log -1 --pretty=%B', returnStdout: true).trim()
                    if (commitMessage.contains('[skip ci]')) {
                        echo "‚è≠Ô∏è [skip ci] Ïª§Î∞ã - ÎπåÎìú Ïä§ÌÇµ"
                        currentBuild.result = 'SUCCESS'
                        return
                    }
                    def changedFiles = sh(script: 'git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only origin/main...HEAD 2>/dev/null || echo ""', returnStdout: true).trim()
                    if (!changedFiles) {
                        echo "‚è≠Ô∏è Î≥ÄÍ≤Ω ÏóÜÏùå - ÎπåÎìú Ïä§ÌÇµ"
                        currentBuild.result = 'SUCCESS'
                        return
                    }
                    def frontendChanged = false
                    changedFiles.split('\n').each { file ->
                        if (file.trim().contains('dev/alphacar/frontend')) {
                            frontendChanged = true
                        }
                    }
                    if (!frontendChanged) {
                        echo "‚è≠Ô∏è frontend Í≤ΩÎ°ú Î≥ÄÍ≤Ω ÏóÜÏùå - ÎπåÎìú Ïä§ÌÇµ"
                        currentBuild.result = 'SUCCESS'
                        return
                    }
                    
                    cleanWs()
                    checkout scm
                    sh '''
                        echo "üßπ ÎπåÎìú Ï†Ñ Docker Î¶¨ÏÜåÏä§ Ï†ïÎ¶¨ Ï§ë..."
                        docker image prune -f || true
                        docker container prune -f || true
                        docker builder prune -f || true
                        echo "‚úÖ Docker Î¶¨ÏÜåÏä§ Ï†ïÎ¶¨ ÏôÑÎ£å"
                    '''
                    def baseVer = "1.0"
                    def versionPath = 'dev/alphacar/frontend/version.txt'
                    try {
                        if (fileExists(versionPath)) {
                            baseVer = readFile(versionPath).trim()
                        }
                    } catch (e) {
                        echo "‚ö†Ô∏è version.txt ÏùΩÍ∏∞ Ïã§Ìå® ‚Üí 1.0 ÏÇ¨Ïö©"
                    }
                    env.GIT_SHA = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    env.FULL_VERSION = "${baseVer}.${currentBuild.number}-${env.GIT_SHA}"
                    echo "üì¶ ÎπåÎìú Î≤ÑÏ†Ñ: ${env.FULL_VERSION}"
                }
            }
        }
        stage('2. Security & Quality Analysis') {
            when { 
                allOf {
                    expression { params.ACTION == 'build_and_deploy' }
                    expression { !params.SKIP_SONAR }
                }
            }
            steps {
                script {
                    def scannerHome = tool name: 'sonar-scanner'
                    dir('dev/alphacar/frontend') {
                        timeout(time: 30, unit: 'MINUTES') {
                            withEnv(["SONAR_SCANNER_OPTS=-Xmx2048m -Xms512m"]) {
                                withSonarQubeEnv('sonarqube') {
                                    sh """
                                        ${scannerHome}/bin/sonar-scanner \
                                        -Dsonar.projectKey=alphacar-frontend \
                                        -Dsonar.sources=. \
                                        -Dsonar.host.url=http://localhost:9000 \
                                        -Dsonar.login=squ_273d18a8d287084a242da2c1ea88fcebc4090873 \
                                        -Dsonar.scanner.socketTimeout=1800 \
                                        -Dsonar.scanner.connectTimeout=600 \
                                        -Dsonar.analysis.mode=publish
                                    """
                                }
                            }
                        }
                    }
                }
            }
        }
        stage('3. Docker Build & Push to ECR') {
            when { expression { params.ACTION == 'build_and_deploy' } }
            steps {
                script {
                    def imageFullTag = "${ECR_REGISTRY}/${IMAGE_NAME}:${env.FULL_VERSION}"
                    echo "üê≥ ÎèÑÏª§ ÎπåÎìú ÏãúÏûë: ${imageFullTag}"
                    dir('dev/alphacar/frontend') {
                        sh "docker build -f Dockerfile -t ${imageFullTag} ."
                        script {
                            def awsPath = sh(script: 'which aws || echo /usr/local/bin/aws', returnStdout: true).trim()
                            if (!awsPath || !fileExists(awsPath)) {
                                error "AWS CLI not found. Please install AWS CLI on the Jenkins server."
                            }
                            sh """
                                ${awsPath} ecr get-login-password --region ${AWS_REGION} | \\
                                docker login --username AWS --password-stdin ${ECR_REGISTRY}
                            """
                        }
                        sh "docker push ${imageFullTag}"
                        sh "docker logout ${ECR_REGISTRY}"
                    }
                }
            }
        }
        stage('4. Update Manifest (GitOps)') {
            when { expression { params.ACTION == 'build_and_deploy' } }
            steps {
                script {
                    dir('manifest-update') {
                        checkout([$class: 'GitSCM', branches: [[name: 'main']], userRemoteConfigs: [[url: "${env.MANIFEST_REPO_URL}", credentialsId: "${env.GIT_CREDENTIAL_ID}"]])
                        withCredentials([usernamePassword(credentialsId: env.GIT_CREDENTIAL_ID, usernameVariable: 'GH_USER', passwordVariable: 'GH_TOKEN')]) {
                            sh """
                                git checkout -B main || git checkout main
                                TARGET_FILE="k8s/frontend/frontend-deployment-multimaster.yaml"
                                if [ -f "\$TARGET_FILE" ]; then
                                    echo "üìù Manifest ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë: \$TARGET_FILE"
                                    sed -i "s|image: .*|image: ${ECR_REGISTRY}/${IMAGE_NAME}:${env.FULL_VERSION}|" "\$TARGET_FILE"
                                    git config user.email "jenkins@alphacar.com"
                                    git config user.name "Jenkins-CI"
                                    git add .
                                    if [ -n "\$(git status --porcelain)" ]; then
                                        git commit -m "Update frontend image to ${env.FULL_VERSION} [skip ci]"
                                        git push https://\${GH_TOKEN}@github.com/Alphacar-project/alphacar-k8s.git HEAD:main
                                        echo "‚úÖ GitOps Î†àÌè¨ÏßÄÌÜ†Î¶¨ Ìë∏Ïãú ÏÑ±Í≥µ"
                                    else
                                        echo "‚ÑπÔ∏è Î≥ÄÍ≤Ω ÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§."
                                    fi
                                else
                                    echo "‚ùå ÏóêÎü¨: \$TARGET_FILE ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."
                                    exit 1
                                fi
                            """
                        }
                    }
                }
            }
        }
    }
    post {
        always {
            sh """
                docker image prune -f || true
                docker container prune -f || true
                docker builder prune -f || true
            """
            cleanWs()
        }
    }
}
