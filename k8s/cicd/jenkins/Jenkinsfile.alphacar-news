pipeline {
    agent any
    parameters {
        choice(name: 'ACTION',
               choices: ['build_and_deploy', 'skip_build'],
               description: 'alphacar-news ë¹Œë“œ ë° ë°°í¬ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')
        string(name: 'VERSION', defaultValue: '1.0', description: 'ê¸°ë³¸ ë²„ì „')
    }
    environment {
        ECR_REGISTRY = '382045063773.dkr.ecr.ap-northeast-2.amazonaws.com'
        AWS_REGION = 'ap-northeast-2'
        IMAGE_NAME = 'alphacar/alphacar-news'
        APP_NAME = 'news'
        GIT_CREDENTIAL_ID = 'github-cred'
        SONARQUBE_NAME = 'SonarQube'
        SONAR_HOST_URL = 'http://192.168.0.170:32000'
        MANIFEST_REPO_URL = 'https://github.com/Alphacar-project/alphacar-k8s.git'
            }
    stages {
        stage('0. Check Changes') {
            when { expression { params.ACTION == 'build_and_deploy' } }
            steps {
                script {
                    echo "ğŸ” ë³€ê²½ëœ íŒŒì¼ í™•ì¸ ì¤‘..."
                    
                    // ë¨¼ì € ì½”ë“œ ì²´í¬ì•„ì›ƒ (ë³€ê²½ì‚¬í•­ í™•ì¸ì„ ìœ„í•´)
                    checkout scm
                    
                    // ì»¤ë°‹ ë©”ì‹œì§€ í™•ì¸ ([skip ci] ì²´í¬)
                    def commitMessage = sh(
                        script: 'git log -1 --pretty=%B',
                        returnStdout: true
                    ).trim()
                    
                    if (commitMessage.contains('[skip ci]')) {
                        echo "â­ï¸ [skip ci] ì»¤ë°‹ ê°ì§€ - ë¹Œë“œë¥¼ ìŠ¤í‚µí•©ë‹ˆë‹¤."
                        echo "ì»¤ë°‹ ë©”ì‹œì§€: ${commitMessage}"
                                                currentBuild.result = 'SUCCESS'
                        return
                        return due to [skip ci] commit")
                    }
                    
                    // Git ë³€ê²½ì‚¬í•­ í™•ì¸
                    def changedFiles = sh(
                        script: '''
                            git diff --name-only HEAD~1 HEAD 2>/dev/null || \
                            git diff --name-only origin/main...HEAD 2>/dev/null || \
                            echo ""
                        ''',
                        returnStdout: true
                    ).trim()
                    
                    if (!changedFiles) {
                        echo "âš ï¸ ë³€ê²½ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
                                                currentBuild.result = 'SUCCESS'
                        return
                        return - no changes detected")
                    }
                    
                    echo "ë³€ê²½ëœ íŒŒì¼ ëª©ë¡:\n${changedFiles}"
                    
                    // news ê²½ë¡œ ë³€ê²½ í™•ì¸
                    def newsChanged = false
                    def fileList = changedFiles.split('\n')
                    
                    for (file in fileList) {
                        file = file.trim()
                        if (file && file.contains('dev/alphacar/backend/news')) {
                            newsChanged = true
                            echo "âœ… news ê´€ë ¨ ë³€ê²½ ê°ì§€: ${file}"
                            break
                        }
                    }
                    
                    if (!newsChanged) {
                        echo "â­ï¸ news ê²½ë¡œ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. ë¹Œë“œë¥¼ ìŠ¤í‚µí•©ë‹ˆë‹¤."
                        echo "ë³€ê²½ëœ ê²½ë¡œ:\n${changedFiles}"
                                                currentBuild.result = 'SUCCESS'
                        return
                        return - no news path changes")
                    }
                    
                    echo "âœ… news ë³€ê²½ì‚¬í•­ í™•ì¸ë¨ - ë¹Œë“œ ì§„í–‰"
                    env.                }
            }
        }
        stage('1. Prepare') {
            when { 
                expression { params.ACTION == 'build_and_deploy' }
            }
            steps {
                script {
                    cleanWs()
                    checkout scm
                    // ë””ìŠ¤í¬ ê³µê°„ í™•ë³´ë¥¼ ìœ„í•œ Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬
                    sh '''
                        echo "ğŸ§¹ ë¹Œë“œ ì „ Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì¤‘..."
                        docker image prune -f || true
                        docker container prune -f || true
                        docker builder prune -f || true
                        echo "âœ… Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì™„ë£Œ"
                    '''
                    def baseVer = "1.0"
                    def versionPath = 'dev/alphacar/backend/version.txt'
                    if (fileExists(versionPath)) {
                        baseVer = readFile(versionPath).trim()
                    }
                    env.GIT_SHA = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    env.FULL_VERSION = "${baseVer}.${currentBuild.number}-${env.GIT_SHA}"
                }
            }
        }
        stage('2. Security & Analysis') {
            when { 
                expression { params.ACTION == 'build_and_deploy' }
            }
            steps {
                script {
                    def scannerHome = tool name: 'sonar-scanner'
                    dir('dev/alphacar/backend/news') {
                        // SonarQube ë¶„ì„
                        withSonarQubeEnv('sonarqube') {
                            sh "${scannerHome}/bin/sonar-scanner \
                                -Dsonar.projectKey=alphacar-news \
                                -Dsonar.sources=. \
                                -Dsonar.host.url=http://localhost:9000 \
                                -Dsonar.login=squ_273d18a8d287084a242da2c1ea88fcebc4090873"
                        }
                    }
                }
            }
        }
        stage('3. Docker Build & Push to ECR') {
            when { 
                expression { params.ACTION == 'build_and_deploy' }
            }
            steps {
                script {
                    def imageFullTag = "${ECR_REGISTRY}/${IMAGE_NAME}:${env.FULL_VERSION}"
                    dir('dev/alphacar/backend/news') {
                        sh "docker build --build-arg APP_NAME=${APP_NAME} --build-arg BUILDKIT_INLINE_CACHE=1 -f Dockerfile -t ${imageFullTag} ."
                        // AWS ECR ë¡œê·¸ì¸
                        script {
                            def awsPath = sh(script: 'which aws || echo /usr/local/bin/aws', returnStdout: true).trim()
                            if (!awsPath || !fileExists(awsPath)) {
                                error "AWS CLI not found. Please install AWS CLI on the Jenkins server."
                            }
                            sh """
                                ${awsPath} ecr get-login-password --region ${AWS_REGION} | \\
                                docker login --username AWS --password-stdin ${ECR_REGISTRY}
                            """
                        }
                        sh "docker push ${imageFullTag}"
                        sh "docker logout ${ECR_REGISTRY}"
                    }
                }
            }
        }
        stage('4. Update Manifest') {
            when { 
                expression { params.ACTION == 'build_and_deploy' }
            }
            steps {
                script {
                    dir('manifest-update') {
                        checkout([$class: 'GitSCM', 
                            branches: [[name: 'main']], 
                            userRemoteConfigs: [[url: "${env.MANIFEST_REPO_URL}", credentialsId: "${env.GIT_CREDENTIAL_ID}"]]
                        ])
                        def yamlPath = "k8s/backend/news-backend.yaml"
                        withCredentials([usernamePassword(credentialsId: env.GIT_CREDENTIAL_ID, usernameVariable: 'GH_USER', passwordVariable: 'GH_TOKEN')]) {
                            sh """
                                # ë¸Œëœì¹˜ í™•ì¸ ë° ì „í™˜
                                git checkout -B main || git checkout main
                                if [ -f "${yamlPath}" ]; then
                                    sed -i 's|image: .*/alphacar-news:.*|image: ${ECR_REGISTRY}/${IMAGE_NAME}:${env.FULL_VERSION}|' ${yamlPath}
                                    echo "âœ… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${yamlPath}"
                                fi
                                git config user.email "jenkins@alphacar.com"
                                git config user.name "Jenkins-CI"
                                git add .
                                if [ -n "\$(git status --porcelain)" ]; then
                                    git commit -m "Update alphacar-news image to ${env.FULL_VERSION} [skip ci]"
                                    git push https://\${GH_TOKEN}@github.com/Alphacar-project/alphacar-k8s.git HEAD:main
                                    echo "âœ… GitOps ë ˆí¬ì§€í† ë¦¬ í‘¸ì‹œ ì„±ê³µ"
                                fi
                            """
                        }
                    }
                }
            }
        }
    }
    post {
        always {
            sh """
                docker image prune -f || true
                docker container prune -f || true
                docker builder prune -f || true
            """
            cleanWs()
        }
    }
}
