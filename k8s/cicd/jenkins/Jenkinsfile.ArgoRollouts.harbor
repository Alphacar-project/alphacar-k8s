pipeline {
    agent any

    // [ìë™í™” ë¶„ë¦¬] ë°±ì—”ë“œ í´ë”(dev/alphacar/backend) ë³€ê²½ ì‹œì—ë§Œ ë¹Œë“œ ìˆ˜í–‰
    triggers {
        GenericTrigger(
            genericVariables: [
                [key: 'changedFiles', value: '$.commits[*].modified[*]']
            ],
            regexpFilterText: '$changedFiles',
            regexpFilterExpression: '.*dev/alphacar/backend/.*', 
            token: 'backend-token' 
        )
    }

    parameters {
        choice(name: 'ACTION',
               choices: ['build_and_deploy', 'skip_build'],
               description: 'ë°±ì—”ë“œ ë¹Œë“œ ë° ë°°í¬ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')
        choice(name: 'DEPLOY_STRATEGY',
               choices: ['blue-green', 'canary'],
               description: 'ë°°í¬ ì „ëµ ì„ íƒ')
        string(name: 'VERSION', defaultValue: '1.0', description: 'ê¸°ë³¸ ë²„ì „')
    }

    environment {
        HARBOR_URL      = '192.168.0.170:30000'
        HARBOR_PROJECT  = 'alphacar'
        IMAGE_NAME      = 'alphacar-main'  // main-backend ì„œë¹„ìŠ¤
        HARBOR_CRED_ID  = 'harbor-cred'
        GIT_CREDENTIAL_ID = 'github-cred'
        SONARQUBE_NAME = 'SonarQube'
        SONAR_HOST_URL = 'http://192.168.0.170:32000'
        MANIFEST_REPO_URL = 'https://github.com/Alphacar-project/alphacar-k8s.git'
        K8S_NAMESPACE = 'apc-be-ns'
        ROLLOUT_NAME = 'main-backend'
    }

    stages {
        stage('1. Prepare') {
            when { expression { params.ACTION == 'build_and_deploy' } }
            steps {
                cleanWs()
                checkout scm
                script {
                    def baseVer = "1.0"
                    def versionPath = 'dev/alphacar/backend/version.txt'
                    if (fileExists(versionPath)) {
                        baseVer = readFile(versionPath).trim()
                    }
                    env.GIT_SHA = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    env.FULL_VERSION = "${baseVer}.${currentBuild.number}-${env.GIT_SHA}"
                    
                    // Trivy ì„¤ì¹˜ ì²´í¬
                    sh '''
                        if ! command -v trivy &> /dev/null; then
                            curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /tmp
                        fi
                    '''
                    
                    // kubectl ë° argo-rollouts CLI í™•ì¸
                    sh '''
                        if ! command -v kubectl &> /dev/null; then
                            echo "kubectlì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤."
                            exit 1
                        fi
                        if ! command -v kubectl-argo-rollouts &> /dev/null; then
                            echo "kubectl-argo-rollouts CLI ì„¤ì¹˜ ì¤‘..."
                            curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
                            chmod +x ./kubectl-argo-rollouts-linux-amd64
                            sudo mv ./kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts || mv ./kubectl-argo-rollouts-linux-amd64 /tmp/kubectl-argo-rollouts
                        fi
                    '''
                }
            }
        }

        stage('2. Security & Analysis') {
            when { expression { params.ACTION == 'build_and_deploy' } }
            steps {
                script {
                    def scannerHome = tool name: 'sonar-scanner'
                    dir('dev/alphacar/backend') {
                        // SonarQube ë¶„ì„ (ìºì‹œ í™œì„±í™”)
                        withSonarQubeEnv("${env.SONARQUBE_NAME}") {
                            sh "${scannerHome}/bin/sonar-scanner -Dsonar.projectKey=alphacar-backend -Dsonar.analysis.cache=true -Dsonar.sources=."
                        }
                        
                        // ë°±ì—”ë“œ ì·¨ì•½ì  ìŠ¤ìº”
                        echo "ğŸ›¡ï¸ ë°±ì—”ë“œ ì†ŒìŠ¤ ì½”ë“œ ì·¨ì•½ì  ìŠ¤ìº” ì¤‘..."
                        sh "/tmp/trivy fs --severity CRITICAL,HIGH --exit-code 0 ."
                    }
                }
            }
        }

        stage('3. ê³ ì† Docker Build & Push') {
            when { expression { params.ACTION == 'build_and_deploy' } }
            steps {
                script {
                    def imageFullTag = "${HARBOR_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:${env.FULL_VERSION}"
                    dir('dev/alphacar/backend') {
                        // BUILDKIT ìºì‹œ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œ ì†ë„ í–¥ìƒ
                        sh "docker build --build-arg BUILDKIT_INLINE_CACHE=1 -f Dockerfile -t ${imageFullTag} ."
                        
                        withCredentials([usernamePassword(credentialsId: HARBOR_CRED_ID, usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                            sh "echo '${PASS}' | docker login ${HARBOR_URL} -u ${USER} --password-stdin"
                            sh "docker push ${imageFullTag}"
                        }
                    }
                }
            }
        }

        stage('4. Update Rollout Manifest') {
            when { expression { params.ACTION == 'build_and_deploy' } }
            steps {
                script {
                    dir('manifest-update') {
                        checkout([$class: 'GitSCM', 
                            branches: [[name: 'main']], 
                            userRemoteConfigs: [[url: "${env.MANIFEST_REPO_URL}", credentialsId: "${env.GIT_CREDENTIAL_ID}"]]
                        ])
                        
                        // Argo Rollouts YAML ê²½ë¡œì— ë§ì¶° ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
                        def rolloutPath = "k8s/cicd/argorollouts/main-backend-rollout-bluegreen.yaml"
                        if (params.DEPLOY_STRATEGY == 'canary') {
                            rolloutPath = "k8s/cicd/argorollouts/main-backend-rollout.yaml"
                        }
                        
                        sh """
                            if [ -f "${rolloutPath}" ]; then
                                # ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
                                sed -i 's|image: .*/${IMAGE_NAME}:.*|image: ${HARBOR_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:${env.FULL_VERSION}|' ${rolloutPath}
                                
                                git config user.email "jenkins@alphacar.com"
                                git config user.name "Jenkins-CI"
                                git add .
                                if [ -n "\$(git status --porcelain)" ]; then
                                    git commit -m "Update ${ROLLOUT_NAME} image to ${env.FULL_VERSION} [skip ci]"
                                    git push origin main
                                fi
                            else
                                echo "âš ï¸ Rollout íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${rolloutPath}"
                            fi
                        """
                    }
                }
            }
        }

        stage('5. Deploy with Argo Rollouts') {
            when { expression { params.ACTION == 'build_and_deploy' } }
            steps {
                script {
                    dir('manifest-update') {
                        // Argo Rolloutsë¥¼ ì‚¬ìš©í•œ ë°°í¬
                        sh """
                            echo "ğŸš€ Argo Rolloutsë¥¼ ì‚¬ìš©í•œ Blue-Green ë°°í¬ ì‹œì‘..."
                            
                            # Rollout ì ìš©
                            kubectl apply -f k8s/cicd/argorollouts/main-backend-rollout-bluegreen.yaml -n ${K8S_NAMESPACE}
                            
                            # ë°°í¬ ìƒíƒœ í™•ì¸ (ìµœëŒ€ 5ë¶„ ëŒ€ê¸°)
                            timeout 300 bash -c 'until kubectl argo rollouts get rollout ${ROLLOUT_NAME} -n ${K8S_NAMESPACE} | grep -q "Healthy"; do sleep 5; done' || true
                            
                            # ë°°í¬ ìƒíƒœ ì¶œë ¥
                            kubectl argo rollouts get rollout ${ROLLOUT_NAME} -n ${K8S_NAMESPACE}
                        """
                    }
                }
            }
        }

        stage('6. Promote (Optional)') {
            when { 
                expression { 
                    params.ACTION == 'build_and_deploy' && 
                    params.DEPLOY_STRATEGY == 'blue-green' 
                } 
            }
            steps {
                script {
                    echo "â¸ï¸ Blue-Green ë°°í¬ê°€ Preview ìƒíƒœë¡œ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤."
                    echo "ğŸ“Š Argo Rollouts ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸ í›„ ìˆ˜ë™ìœ¼ë¡œ Promoteí•˜ì„¸ìš”:"
                    echo "   kubectl argo rollouts promote ${ROLLOUT_NAME} -n ${K8S_NAMESPACE}"
                    echo ""
                    echo "ë˜ëŠ” ìë™ ìŠ¹ì¸ì„ ì›í•˜ì‹œë©´ ë‹¤ìŒ ë‹¨ê³„ë¥¼ í™œì„±í™”í•˜ì„¸ìš”."
                    
                    // ìë™ ìŠ¹ì¸ì„ ì›í•˜ëŠ” ê²½ìš° ì•„ë˜ ì£¼ì„ í•´ì œ
                    // sh "kubectl argo rollouts promote ${ROLLOUT_NAME} -n ${K8S_NAMESPACE}"
                }
            }
        }
    }

    post {
        always {
            sh "docker image prune -f"
            cleanWs()
        }
        success {
            script {
                echo "âœ… ë°°í¬ ì™„ë£Œ!"
                echo "ğŸ“Š Rollout ìƒíƒœ í™•ì¸:"
                sh "kubectl argo rollouts get rollout ${ROLLOUT_NAME} -n ${K8S_NAMESPACE} || true"
            }
        }
        failure {
            echo "âŒ ë°°í¬ ì‹¤íŒ¨! ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
        }
    }
}

