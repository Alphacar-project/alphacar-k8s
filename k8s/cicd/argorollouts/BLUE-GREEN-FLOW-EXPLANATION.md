# Blue-Green 배포 흐름도 설명

## 🎯 Blue-Green 배포란?

**두 개의 동일한 환경(Blue, Green)을 준비하고, 트래픽을 한쪽에서 다른 쪽으로 전환하는 배포 방식**

---

## 📊 기본 개념

```
┌─────────────┐         ┌─────────────┐
│   Blue      │         │   Green     │
│ (현재 운영)  │         │ (새 버전)   │
│  v1.0       │         │  v2.0       │
└─────────────┘         └─────────────┘
      │                        │
      └────────┬───────────────┘
               │
         [트래픽 전환]
```

---

## 🔄 Blue-Green 배포 흐름

### Step 1: 초기 상태 (Blue 운영 중)

```
사용자 트래픽
    │
    ▼
┌─────────┐
│  Blue   │ ← 현재 프로덕션 (v1.0)
│  v1.0   │   모든 사용자가 접속
└─────────┘

┌─────────┐
│  Green  │ ← 비어있음 (없음)
│  (없음) │
└─────────┘
```

**상태**: Blue만 실행 중, Green은 없음

---

### Step 2: 새 버전 배포 (Green 생성)

```
사용자 트래픽
    │
    ▼
┌─────────┐
│  Blue   │ ← 여전히 프로덕션 (v1.0)
│  v1.0   │   사용자는 여전히 Blue 접속
└─────────┘

┌─────────┐
│  Green  │ ← 새 버전 배포 (v2.0) - Preview
│  v2.0   │   아직 사용자 접속 없음
└─────────┘
```

**상태**: 
- Blue: 프로덕션 (사용자 접속 중)
- Green: Preview (새 버전, 테스트 가능)

**명령어**:
```bash
kubectl-argo-rollouts set image frontend \
  frontend=새버전이미지 -n apc-fe-ns
```

---

### Step 3: Preview 확인 (Green 테스트)

```
사용자 트래픽
    │
    ▼
┌─────────┐
│  Blue   │ ← 프로덕션 (v1.0)
│  v1.0   │   사용자는 여전히 Blue 접속
└─────────┘

┌─────────┐
│  Green  │ ← Preview (v2.0)
│  v2.0   │   관리자만 접속해서 테스트
└─────────┘
    ▲
    │
  테스트
```

**상태**:
- Blue: 프로덕션 (일반 사용자 접속)
- Green: Preview (관리자만 테스트)

**확인 방법**:
- Preview 서비스로 접속하여 새 버전 테스트
- 문제 없으면 Promote 준비

---

### Step 4: Promote (Blue → Green 전환)

```
사용자 트래픽
    │
    ▼
┌─────────┐
│  Blue   │ ← 이전 버전 (v1.0)
│  v1.0   │   더 이상 사용자 접속 없음
└─────────┘

┌─────────┐
│  Green  │ ← 새 프로덕션 (v2.0) ✅
│  v2.0   │   모든 사용자가 여기로 접속
└─────────┘
```

**상태**:
- Blue: 이전 버전 (대기 상태)
- Green: 새 프로덕션 (모든 사용자 접속)

**명령어**:
```bash
kubectl-argo-rollouts promote frontend -n apc-fe-ns
```

**Promote = 새 버전을 프로덕션으로 전환**

---

### Step 5: Blue 정리 (선택사항)

```
사용자 트래픽
    │
    ▼
┌─────────┐
│  Blue   │ ← 삭제 또는 유지
│  v1.0   │   (롤백 대비)
└─────────┘

┌─────────┐
│  Green  │ ← 프로덕션 (v2.0)
│  v2.0   │   모든 사용자 접속
└─────────┘
```

**상태**: Green만 프로덕션으로 운영

---

## 🔄 롤백 흐름

### 롤백 = Green → Blue로 다시 전환

```
사용자 트래픽
    │
    ▼
┌─────────┐
│  Blue   │ ← 다시 프로덕션 (v1.0) ✅
│  v1.0   │   모든 사용자가 여기로 복귀
└─────────┘

┌─────────┐
│  Green  │ ← 문제 있는 버전 (v2.0)
│  v2.0   │   더 이상 사용자 접속 없음
└─────────┘
```

**명령어**:
```bash
kubectl-argo-rollouts undo frontend -n apc-fe-ns
# 또는
kubectl-argo-rollouts set image frontend \
  frontend=이전버전이미지 -n apc-fe-ns
```

---

## 📋 우리 시나리오 흐름

### 현재 상황

```
사용자 트래픽
    │
    ▼
┌─────────┐
│  Blue   │ ← 프로덕션
│  v1.054 │   "Hello 크리스마스 🎄" 있음
│(크리스마스)│
└─────────┘

┌─────────┐
│  Green  │ ← Preview
│  v1.053 │   "Hello 크리스마스 🎄" 없음
│(이전버전)│
└─────────┘
```

---

### Step 1: Promote 실행

```bash
kubectl-argo-rollouts promote frontend -n apc-fe-ns
```

**결과**:

```
사용자 트래픽
    │
    ▼
┌─────────┐
│  Blue   │ ← 이전 버전 (대기)
│  v1.054 │   더 이상 사용자 접속 없음
│(크리스마스)│
└─────────┘

┌─────────┐
│  Green  │ ← 새 프로덕션 ✅
│  v1.053 │   모든 사용자가 여기로 접속
│(이전버전)│   "Hello 크리스마스 🎄" 없음
└─────────┘
```

**변화**: 
- 사용자가 접속하는 버전이 변경됨
- "Hello 크리스마스 🎄" 사라짐

---

## ✅ 핵심 정리

### Promote는?
- ✅ **새 버전을 프로덕션으로 전환**
- ✅ **Blue → Green으로 트래픽 전환**
- ❌ **롤백이 아님!**

### 롤백은?
- ✅ **이전 버전으로 되돌리기**
- ✅ **Green → Blue로 다시 전환**
- ✅ **`undo` 명령어 사용**

---

## 🎬 우리 시나리오 요약

### 현재
- **Blue (프로덕션)**: 크리스마스 버전 (Hello 크리스마스 있음)
- **Green (Preview)**: 이전 버전 (Hello 크리스마스 없음)

### Promote 실행 후
- **Blue (대기)**: 크리스마스 버전
- **Green (프로덕션)**: 이전 버전 ← 사용자가 여기 접속

### 결과
- 사용자가 보는 화면: "Hello 크리스마스 🎄" **사라짐**
- 이것이 **롤백 효과** (크리스마스 버전에서 이전 버전으로)

---

## 💡 비유

### Promote = 새 집으로 이사

1. **초기**: Blue 집에 살고 있음 (크리스마스 장식 있음)
2. **Green 집 준비**: 새 집 준비 완료 (장식 없음)
3. **Promote**: Green 집으로 이사 (장식 없음)
4. **결과**: 장식 없는 집에서 살게 됨 (롤백 효과)

---

## 📊 명령어 정리

| 명령어 | 의미 | 결과 |
|--------|------|------|
| `set image` | 새 버전 배포 | Green 생성 (Preview) |
| `promote` | 새 버전을 프로덕션으로 전환 | Blue → Green 전환 |
| `undo` | 이전 버전으로 롤백 | Green → Blue 전환 |

---

## ✅ 최종 정리

1. **Promote ≠ 롤백**
   - Promote: 새 버전을 프로덕션으로 전환
   - 롤백: 이전 버전으로 되돌리기

2. **우리 시나리오**
   - 현재: 크리스마스 버전 (Blue)이 프로덕션
   - Preview: 이전 버전 (Green) 준비됨
   - Promote: 이전 버전 (Green)을 프로덕션으로 전환
   - 결과: 크리스마스 버전에서 이전 버전으로 (롤백 효과)

3. **흐름**
   ```
   크리스마스 버전 (Blue) → Promote → 이전 버전 (Green)
   프로덕션              → 전환    → 새 프로덕션
   ```

