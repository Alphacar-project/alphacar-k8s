apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: main-backend
  namespace: apc-be-ns
  labels:
    app: main-backend
spec:
  replicas: 1
  revisionHistoryLimit: 1
  selector:
    matchLabels:
      app: main-backend
  template:
    metadata:
      labels:
        app: main-backend
        version: stable
      annotations:
        sidecar.istio.io/inject: "true"
    spec:
      imagePullSecrets:
      - name: harbor-registry-secret
      containers:
      - name: main-backend
        image: 382045063773.dkr.ecr.ap-northeast-2.amazonaws.com/alphacar/alphacar-main:1.0.0.15-13c59c7
        imagePullPolicy: Always
        ports:
        - containerPort: 3000
          name: http-main
        env:
        - name: PORT
          value: "3000"
        - name: SERVICE_NAME
          value: "main-backend"
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          valueFrom:
            configMapKeyRef:
              name: alphacar-be-config
              key: OTEL_EXPORTER_OTLP_ENDPOINT
        - name: MARIADB_HOST
          valueFrom:
            configMapKeyRef:
              name: alphacar-be-config
              key: MARIADB_HOST
        - name: MARIADB_PORT
          valueFrom:
            configMapKeyRef:
              name: alphacar-be-config
              key: MARIADB_PORT
        - name: MARIADB_USERNAME
          valueFrom:
            secretKeyRef:
              name: alphacar-be-secret
              key: MARIADB_USER
        - name: MARIADB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: alphacar-be-secret
              key: MARIADB_PASS
        - name: MARIADB_DATABASE
          valueFrom:
            secretKeyRef:
              name: alphacar-be-secret
              key: MARIADB_DB_NAME
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
  strategy:
    blueGreen:
      # Istio 트래픽 관리
      trafficManagement:
        istio:
          virtualService:
            name: main-backend-vs
            routes:
            - primary
          destinationRule:
            name: main-backend-dr
            activeSubsetName: stable  # 활성 서브셋
            previewSubsetName: preview  # 미리보기 서브셋
      
      # 활성 서비스 (현재 프로덕션)
      activeService: main-backend-stable
      
      # 미리보기 서비스 (새 버전)
      previewService: main-backend-preview
      
      # 자동 승인 비활성화 (수동 승인으로 영상 촬영에 적합)
      autoPromotionEnabled: false
      
      # 스케일 다운 지연 시간 (롤백 시)
      scaleDownDelaySeconds: 30
      
      # 프리뷰 트래픽 활성화 (새 버전 테스트용)
      previewReplicaCount: 1
---
# Stable Service (현재 프로덕션)
apiVersion: v1
kind: Service
metadata:
  name: main-backend-stable
  namespace: apc-be-ns
spec:
  selector:
    app: main-backend
    version: stable
  ports:
  - port: 3000
    targetPort: 3000
    protocol: TCP
    name: http-main
  type: ClusterIP
---
# Preview Service (새 버전)
apiVersion: v1
kind: Service
metadata:
  name: main-backend-preview
  namespace: apc-be-ns
spec:
  selector:
    app: main-backend
    version: preview
  ports:
  - port: 3000
    targetPort: 3000
    protocol: TCP
    name: http-main
  type: ClusterIP
---
# DestinationRule
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: main-backend-dr
  namespace: apc-be-ns
spec:
  host: main-backend-stable
  subsets:
  - name: stable
    labels:
      app: main-backend
      version: stable
  - name: preview
    labels:
      app: main-backend
      version: preview
---
# ⚠️ 주의: VirtualService는 Argo Rollouts가 자동으로 생성/관리합니다!
# 이 파일은 참고용이며, 실제로는 배포하지 마세요.
# Argo Rollouts의 trafficManagement 설정이 VirtualService를 자동 생성합니다.
#
# 아래는 Argo Rollouts가 생성할 VirtualService의 예시입니다:
#
# apiVersion: networking.istio.io/v1beta1
# kind: VirtualService
# metadata:
#   name: main-backend-vs
#   namespace: apc-be-ns
# spec:
#   hosts:
#   - main-backend-stable
#   gateways:
#   - alphacar-gateway  # Gateway 이름과 일치해야 함
#   http:
#   - name: primary  # Rollout의 routes 필드와 일치해야 함
#     route:
#     - destination:
#         host: main-backend-stable
#         subset: stable  # Blue-Green 전환 시 preview로 변경됨
#       weight: 100

