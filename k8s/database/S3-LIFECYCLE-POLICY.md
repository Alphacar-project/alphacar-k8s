# AlphaCar 프로젝트 S3 수명주기 정책

## 전체 서비스 수명주기 정책

### AlphaCar 프로젝트 개요
AlphaCar는 차량 정보 검색 및 관리 서비스로, 다음과 같은 데이터를 관리합니다:
- **차량 정보 데이터**: MongoDB에 저장된 차량 상세 정보 (데이터 분석용)
- **Kubernetes 인프라**: 클러스터 리소스 및 설정 (재해 복구용)
- **차량 이미지**: 사용자에게 제공되는 차량 이미지 파일 (신차 출시 주기 2년)

### 전체 수명주기 정책 원칙

#### 1. 데이터 분류 및 용도별 중요도
| 데이터 유형 | 용도 | 중요도 | 복원 필요성 | 접근 빈도 | 보존 우선순위 |
|-----------|------|--------|-----------|----------|-------------|
| MongoDB 백업 | 데이터 분석용 | 최고 | 장기 분석 필요 | 낮음 (분석 시에만) | 최고 |
| Velero 백업 | 재해 복구용 | 높음 | 재해 복구 시 필요 | 낮음 (복원 시에만) | 중간 |
| 차량 이미지 | 서비스 제공용 | 중간 | 실시간 서비스 제공 | 높음 (일반 사용자 요청) | 낮음 |

#### 2. 보존 기간 결정 기준
1. **데이터 용도**: 각 데이터의 실제 사용 목적에 따른 보존 기간
2. **비즈니스 요구사항**: 법적/규정 요구사항, 감사 목적, 분석 목적
3. **복원 필요성**: 실제 복원이 필요한 기간
4. **비용 효율성**: 스토리지 비용 대비 데이터 가치
5. **업계 표준**: 각 데이터 유형별 업계 표준 보존 기간

#### 3. 전체 보존 기간 정책

| 데이터 유형 | 용도 | 최근 보존 (STANDARD) | 중기 보존 (STANDARD_IA/GLACIER) | 장기 보존 (DEEP_ARCHIVE) | 최종 삭제 |
|-----------|------|---------------------|-------------------------------|------------------------|----------|
| **MongoDB 백업** | 데이터 분석용 | 7일 | 30일~180일 | 180일~730일 | **2년 (730일)** |
| **Velero 백업** | 재해 복구용 | 7일 | 30일~90일 | 90일~180일 | **6개월 (180일)** |
| **차량 이미지** | 서비스 제공용 | 30일 | 30일~365일 | 365일~730일 | **2년 (730일)** |

**정책 근거**:
- **MongoDB 백업 (2년)**: 
  - **데이터 분석 목적**: 차량 데이터는 장기적인 트렌드 분석, 시계열 분석, 연도별 비교 분석 등에 활용됨
  - **비즈니스 인사이트**: 2년간의 데이터를 보관하여 연도별, 분기별 비교 분석이 가능
  - **법적/규정 요구사항**: 일부 규정에서 2년간 데이터 보존 요구
  - **분석 가치**: 최소 2년간의 데이터가 있어야 의미있는 트렌드 분석 가능
  - **비용 대비 효과**: 데이터 분석을 통한 비즈니스 가치가 스토리지 비용보다 훨씬 큼
  
- **Velero 백업 (6개월)**:
  - **재해 복구 목적**: 재해 복구는 보통 최근 몇 개월 내 백업으로 충분하며, 6개월 이상 된 백업은 실제 환경과 차이가 커져 복원 가치가 낮음
  - **인프라 변경 빈도**: Kubernetes 인프라는 변경이 빈번하므로 오래된 백업의 실용성 급격히 감소
  - **복원 시나리오**: 대부분의 재해 복구는 최근 1-3개월 내 백업으로 해결 가능
  - **비용 효율성**: 6개월 보존으로 주간 백업 약 24개를 유지하여 충분한 복원 지점 제공
  - **업계 표준**: 재해 복구 백업의 일반적인 보존 기간은 3-6개월
  
- **차량 이미지 (2년)**:
  - **신차 출시 주기**: 자동차 업계의 신차 출시 주기는 평균 2년 정도
  - **모델 라이프사이클**: 차량 모델의 전체 라이프사이클을 커버하기 위해 2년 보존 필요
  - **서비스 연속성**: 2년간의 이미지를 보관하여 과거 모델 정보도 제공 가능
  - **사용자 경험**: 사용자가 과거 모델과 신규 모델을 비교할 수 있도록 지원
  - **비용 효율성**: 2년 보존으로 신차 출시 주기와 일치하여 최적의 비용 효율 달성

---

## 버킷별 수명주기 정책 상세

### 1. MongoDB 백업 버킷 (`mongodb-{ACCOUNT_ID}`) - 데이터 분석용

#### 운영 원칙
- **빠른 복원 가능성**: 최근 7일간의 백업은 STANDARD 스토리지에 유지
- **비용 최적화**: 오래된 백업은 저렴한 스토리지로 점진적 이동
- **장기 보존**: 데이터 분석 목적을 위해 2년간 보존

#### 수명주기 정책

| 기간 | 액션 | 스토리지 클래스 | 근거 |
|------|------|----------------|------|
| 0-7일 | 유지 | STANDARD | 최근 백업은 빠른 복원이 필요하므로 표준 스토리지 유지. 일일 백업이므로 최근 7일간은 즉시 복원 가능해야 함 |
| 8-30일 | 전환 | STANDARD_IA | 자주 접근하지 않지만 필요 시 빠른 복원 가능. 월간 백업으로 활용 가능 |
| 31-180일 | 전환 | GLACIER | 중기 보관, 복원 시 3-5시간 소요 가능. 분기별, 반기별 백업으로 활용 |
| 181-730일 | 전환 | DEEP_ARCHIVE | 장기 보관, 복원 시 12시간 소요 가능. 연도별, 2년간 데이터 분석용 백업으로 활용 |
| 731일+ | 삭제 | - | 2년 경과 후 자동 삭제. 데이터 분석 목적상 2년간의 데이터로 충분한 트렌드 분석 가능 |

#### 보존 기간 근거 (2년)
1. **데이터 분석 목적**: 
   - 차량 데이터는 장기적인 트렌드 분석, 시계열 분석, 연도별 비교 분석에 활용
   - 최소 2년간의 데이터가 있어야 의미있는 트렌드 분석 및 패턴 인식 가능
   - 분기별, 연도별 비교 분석을 위해 2년 보존 필요

2. **비즈니스 인사이트**:
   - 2년간의 데이터를 보관하여 연도별, 분기별 비교 분석이 가능
   - 시장 트렌드, 계절성 패턴, 모델별 인기도 변화 등을 분석 가능
   - 데이터 분석을 통한 비즈니스 의사결정 지원

3. **법적/규정 요구사항**:
   - 일부 규정에서 2년간 데이터 보존 요구
   - 감사 및 규정 준수를 위한 장기 보존 필요

4. **비용 대비 효과**:
   - 데이터 분석을 통한 비즈니스 가치가 스토리지 비용보다 훨씬 큼
   - DEEP_ARCHIVE 사용으로 장기 보존 비용 최소화

5. **업계 표준**:
   - 데이터 분석용 백업의 일반적인 보존 기간은 1-3년
   - 2년은 분석 목적에 최적화된 보존 기간

#### 버전 관리 정책
- **현재 버전**: 위 정책 적용
- **이전 버전**: 
  - 30일 후 STANDARD_IA로 전환
  - 90일 후 GLACIER로 전환
  - 180일 후 DEEP_ARCHIVE로 전환
  - 730일 후 자동 삭제

---

### 2. Velero 백업 버킷 (`velero-backup-{ACCOUNT_ID}`) - 재해 복구용

#### 운영 원칙
- **빠른 복원**: 최근 7일간의 백업은 STANDARD 유지
- **중기 보존**: 1개월~6개월 백업은 저렴한 스토리지로 이동
- **재해 복구 목적**: 6개월간 보존하여 충분한 복원 지점 제공

#### 수명주기 정책

| 기간 | 액션 | 스토리지 클래스 | 근거 |
|------|------|----------------|------|
| 0-7일 | 유지 | STANDARD | 최근 백업은 빠른 클러스터 복원 필요. 일일 백업이므로 최근 7일간은 즉시 복원 가능해야 함 |
| 8-30일 | 전환 | STANDARD_IA | 자주 접근하지 않지만 필요 시 빠른 복원. 월간 백업으로 활용 가능 |
| 31-90일 | 전환 | GLACIER | 중기 보관, 복원 시 3-5시간 소요 가능. 분기별 백업으로 활용 |
| 91-180일 | 전환 | DEEP_ARCHIVE | 장기 보관, 복원 시 12시간 소요 가능. 재해 복구용 최종 백업으로 활용 |
| 181일+ | 삭제 | - | 6개월 경과 후 자동 삭제. 재해 복구 목적상 6개월 이상 된 백업은 실제 환경과 차이가 커져 복원 가치가 낮음 |

#### 보존 기간 근거 (6개월)
1. **재해 복구 목적**: 
   - 재해 복구는 보통 최근 몇 개월 내 백업으로 충분
   - 대부분의 재해 복구 시나리오는 최근 1-3개월 내 백업으로 해결 가능
   - 6개월 이상 된 백업은 실제 환경과 차이가 커져 복원 가치가 급격히 감소

2. **인프라 변경 빈도**:
   - Kubernetes 인프라는 변경이 빈번하므로 오래된 백업의 실용성 급격히 감소
   - 인프라 설정은 코드로 관리되므로 장기 보존 필요성 낮음
   - 오래된 백업은 현재 인프라 환경과 호환되지 않을 수 있음

3. **복원 시나리오**:
   - 대부분의 재해 복구는 최근 1-3개월 내 백업으로 해결
   - 6개월 보존으로 주간 백업 약 24개를 유지하여 충분한 복원 지점 제공
   - 다양한 시점의 백업을 보관하여 선택적 복원 가능

4. **비용 효율성**:
   - 재해 복구 목적에 맞는 최적의 보존 기간
   - 6개월 이상 보존 시 비용 대비 효과가 낮음
   - DEEP_ARCHIVE 사용으로 장기 보존 비용 최소화

5. **업계 표준**:
   - 재해 복구 백업의 일반적인 보존 기간은 3-6개월
   - 6개월은 재해 복구 목적에 최적화된 보존 기간

#### 버전 관리 정책
- **현재 버전**: 위 정책 적용
- **이전 버전**: 
  - 30일 후 STANDARD_IA로 전환
  - 90일 후 GLACIER로 전환
  - 180일 후 자동 삭제

#### Velero TTL과의 조정
- Velero Schedule의 TTL 설정:
  - 일일 백업: 30일 (720h)
  - 주간 백업: 90일 (2160h)
- S3 수명주기 정책은 Velero TTL 이후에도 추가 보존 기간 제공하여 최대 6개월까지 보존

---

### 3. 차량 이미지 버킷 (`carimage-{ACCOUNT_ID}`) - 신차 출시 주기 2년

#### 운영 원칙
- **빠른 접근**: 최근 30일간의 이미지는 STANDARD 유지
- **중기 보존**: 1개월~1년 이미지는 저렴한 스토리지로 이동
- **장기 보존**: 신차 출시 주기(2년)에 맞춰 2년간 보존

#### 수명주기 정책

| 기간 | 액션 | 스토리지 클래스 | 근거 |
|------|------|----------------|------|
| 0-30일 | 유지 | STANDARD | 최근 이미지는 자주 접근되므로 표준 스토리지 유지. 신규 차량 정보 조회가 빈번함 |
| 31-365일 | 전환 | STANDARD_IA | 자주 접근하지 않지만 필요 시 빠른 접근 가능. 중기 차량 정보 조회용 |
| 366-730일 | 전환 | GLACIER | 장기 보관, 복원 시 3-5시간 소요 가능. 신차 출시 주기(2년)에 맞춘 장기 보관 |
| 731일+ | 삭제 | - | 2년 경과 후 자동 삭제. 신차 출시 주기(2년)와 일치하여 새로운 모델 사이클 시작 |

#### 보존 기간 근거 (2년)
1. **신차 출시 주기**: 
   - 자동차 업계의 신차 출시 주기는 평균 2년 정도
   - 2년 보존으로 한 사이클의 신차 출시 기간을 완전히 커버
   - 새로운 모델 출시와 함께 이전 모델 이미지 삭제로 자연스러운 사이클 관리

2. **모델 라이프사이클**:
   - 차량 모델의 전체 라이프사이클을 커버하기 위해 2년 보존 필요
   - 신차 출시 → 인기 상승 → 단종까지의 과정을 추적 가능
   - 모델별 인기도 변화 분석에 활용

3. **서비스 연속성**:
   - 2년간의 이미지를 보관하여 과거 모델 정보도 제공 가능
   - 사용자가 과거 모델과 신규 모델을 비교할 수 있도록 지원
   - 모델 변경 이력 추적 가능

4. **사용자 경험**:
   - 사용자가 최근 2년간의 차량 모델 정보를 조회할 수 있음
   - 모델 비교, 가격 변동 추적 등에 활용 가능
   - 신차 출시 주기와 일치하여 사용자 기대에 부합

5. **비용 효율성**:
   - 2년 보존으로 신차 출시 주기와 일치하여 최적의 비용 효율 달성
   - GLACIER 사용으로 장기 보존 비용 최소화
   - 신차 출시 주기와 동기화하여 불필요한 장기 보존 방지

#### 버전 관리 정책
- **현재 버전**: 위 정책 적용
- **이전 버전**: 
  - 90일 후 STANDARD_IA로 전환
  - 180일 후 GLACIER로 전환
  - 730일 후 자동 삭제

---

## 스토리지 클래스 비교

### 비용 비교 (us-east-1 기준, 2025년)

| 스토리지 클래스 | 저장 비용 (GB/월) | 검색 비용 | 복원 시간 | 용도 |
|----------------|------------------|----------|----------|------|
| STANDARD | $0.023 | 없음 | 즉시 | 자주 접근하는 데이터 |
| STANDARD_IA | $0.0125 | $0.01/GB | 즉시 | 자주 접근하지 않는 데이터 |
| GLACIER | $0.004 | $0.02/GB | 3-5시간 | 장기 보관 |
| DEEP_ARCHIVE | $0.00099 | $0.02/GB | 12시간 | 최장기 보관 |

### 선택 기준
1. **STANDARD**: 최근 7-30일간 자주 접근하는 데이터
2. **STANDARD_IA**: 1개월~1년간 가끔 접근하는 데이터
3. **GLACIER**: 3개월~2년간 보관, 가끔 복원하는 데이터
4. **DEEP_ARCHIVE**: 6개월~2년간 보관, 거의 복원하지 않는 데이터

---

## 정책 적용 및 모니터링

### 정책 적용 방법
```bash
# 모든 버킷의 수명주기 정책 설정
./setup-s3-buckets.sh

# 특정 버킷의 수명주기 정책 확인
aws s3api get-bucket-lifecycle-configuration --bucket <bucket-name>
```

### 모니터링 지표
1. **스토리지 사용량**: 각 스토리지 클래스별 사용량 모니터링
2. **비용 추적**: 월별 S3 비용 분석
3. **접근 패턴**: 버킷별 접근 빈도 분석
4. **정책 효과**: 자동 전환 및 삭제 실행 확인

### 정기 검토
- **월간**: 스토리지 사용량 및 비용 검토
- **분기별**: 수명주기 정책 효과 평가 및 조정
- **연간**: 전체 정책 재검토 및 업데이트

---

## 예외 상황 처리

### 장기 보존이 필요한 경우
특정 백업을 장기 보존해야 하는 경우:
1. S3 객체에 태그 추가: `Retention=permanent`
2. 수명주기 정책에서 태그 기반 예외 규칙 추가
3. 또는 수동으로 다른 버킷으로 이동

### 긴급 복원이 필요한 경우
GLACIER/DEEP_ARCHIVE에서 복원:
```bash
# 복원 요청
aws s3api restore-object \
  --bucket <bucket-name> \
  --key <object-key> \
  --restore-request '{"Days":7,"GlacierJobParameters":{"Tier":"Expedited"}}'
```

---

## 비용 최적화 효과

### 전체 비용 절감
- **MongoDB 백업**: 2년 보존으로 데이터 분석 목적 달성, DEEP_ARCHIVE 사용으로 비용 최소화
- **Velero 백업**: 6개월 보존으로 재해 복구 목적 달성, DEEP_ARCHIVE 사용으로 비용 최소화
- **차량 이미지**: 2년 보존으로 신차 출시 주기와 일치, GLACIER 사용으로 비용 최소화

### 월간 예상 비용 (예시)
- MongoDB 백업 (100GB 기준): 약 $0.10 (DEEP_ARCHIVE 사용)
- Velero 백업 (50GB 기준): 약 $0.05 (DEEP_ARCHIVE 사용)
- 차량 이미지 (500GB 기준): 약 $2.00 (GLACIER 사용)

---

## 비용 최적화 팁

1. **불필요한 버전 관리 제한**: 버전 관리가 필요한 버킷만 활성화
2. **정기적인 정책 검토**: 접근 패턴에 따라 정책 조정
3. **태그 활용**: 중요도에 따른 세밀한 정책 적용
4. **모니터링 알림**: 비용 임계값 설정 및 알림

---

## 변경 이력

| 날짜 | 변경 내용 | 담당자 |
|------|----------|--------|
| 2025-12-23 | 초기 정책 수립, 버킷 이름 변경 (yaml → velero-backup) | - |
| 2025-12-23 | 전체 서비스 수명주기 정책 수립, 보존 기간 조정 | - |
| 2025-12-23 | 용도별 수명주기 정책 재수립 (MongoDB: 2년, Velero: 6개월, 차량이미지: 2년) | - |

---

## 참고 자료

- [AWS S3 Lifecycle Policies](https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lifecycle-mgmt.html)
- [AWS S3 Storage Classes](https://aws.amazon.com/s3/storage-classes/)
- [Velero Backup Documentation](https://velero.io/docs/)
