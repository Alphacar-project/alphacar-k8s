# Sealed Secrets Policy
# Bitnami Sealed Secrets 설치 및 정책
# 목적: Secret을 암호화하여 Git에 안전하게 저장하고 관리

---
# 1. Sealed Secrets Controller 설치
# Helm을 사용하거나 직접 설치 가능
# 설치 명령: kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/controller.yaml

apiVersion: v1
kind: Namespace
metadata:
  name: apc-sealed-secrets-ns
  labels:
    name: apc-sealed-secrets-ns
    component: security
    policy: sealed-secret

---
# 2. Sealed Secrets Controller Deployment
# 참고: 실제 설치 시 Helm chart 사용 권장
# helm repo add sealed-secrets https://bitnami-labs.github.io/sealed-secrets
# helm install sealed-secrets sealed-secrets/sealed-secrets -n sealed-secrets

apiVersion: apps/v1
kind: Deployment
metadata:
  name: sealed-secrets-controller
  namespace: apc-sealed-secrets-ns
  labels:
    app: sealed-secrets-controller
    component: security
    policy: sealed-secret
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sealed-secrets-controller
  template:
    metadata:
      labels:
        app: sealed-secrets-controller
    spec:
      serviceAccountName: sealed-secrets-controller
      containers:
      - name: controller
        image: bitnami/sealed-secrets-controller:latest
        imagePullPolicy: IfNotPresent
        args:
        - --update-status
        - --key-renew-period=30d
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi

---
# 3. Sealed Secrets Controller ServiceAccount 및 RBAC
apiVersion: v1
kind: ServiceAccount
metadata:
  name: sealed-secrets-controller
  namespace: apc-sealed-secrets-ns
  labels:
    app: sealed-secrets-controller
    component: security
    policy: sealed-secret

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: sealed-secrets-controller
  labels:
    app: sealed-secrets-controller
    component: security
    policy: sealed-secret
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "create", "update", "patch", "delete", "watch"]
  - apiGroups: ["bitnami.com"]
    resources: ["sealedsecrets"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["bitnami.com"]
    resources: ["sealedsecrets/status"]
    verbs: ["update"]
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: sealed-secrets-controller
  labels:
    app: sealed-secrets-controller
    component: security
    policy: sealed-secret
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: sealed-secrets-controller
subjects:
  - kind: ServiceAccount
    name: sealed-secrets-controller
    namespace: apc-sealed-secrets-ns

---
# 4. Sealed Secrets 사용 정책
# 네임스페이스별로 SealedSecret만 허용하도록 정책 설정
apiVersion: v1
kind: ConfigMap
metadata:
  name: sealed-secrets-policy
  namespace: apc-sealed-secrets-ns
  labels:
    component: security
    policy: sealed-secret
data:
  policy.yaml: |
    # Sealed Secrets 정책
    # 1. 모든 Secret은 SealedSecret으로 변환하여 Git에 저장
    # 2. 네임스페이스별 암호화 키 사용 (선택사항)
    # 3. Secret 직접 생성 금지 (선택사항, 운영 환경에서만)
    
    target-namespaces:
      - apc-be-ns
      - apc-fe-ns
      - apc-db-ns
      - apc-obsv-ns
      - apc-ek-ns
      - apc-striming-ns
      - apc-backup-ns
      - apc-cicd-ns
    
    # SealedSecret 생성 시 사용할 네임스페이스 범위
    # cluster-wide: 모든 네임스페이스에서 사용 가능
    # namespace-wide: 특정 네임스페이스에서만 사용 가능
    scope: namespace-wide

---
# 7. SealedSecret 사용 가이드 및 스크립트
apiVersion: v1
kind: ConfigMap
metadata:
  name: sealed-secrets-usage-guide
  namespace: apc-sealed-secrets-ns
  labels:
    component: security
    policy: sealed-secret
data:
  README.md: |
    # Sealed Secrets 사용 가이드
    
    ## 1. kubeseal CLI 설치
    ```bash
    # Linux
    wget https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/kubeseal-0.24.0-linux-amd64.tar.gz
    tar -xvzf kubeseal-0.24.0-linux-amd64.tar.gz kubeseal
    sudo install -m 755 kubeseal /usr/local/bin/kubeseal
    
    # 또는 Krew 플러그인 사용
    kubectl krew install sealed-secrets
    ```
    
    ## 2. Sealed Secret 생성 방법
    
    ### 방법 1: Secret YAML 파일에서 변환
    ```bash
    # 1. Secret YAML 파일 생성 (평문)
    cat > secret.yaml <<EOF
    apiVersion: v1
    kind: Secret
    metadata:
      name: alphacar-be-secret
      namespace: apc-be-ns
    type: Opaque
    stringData:
      MONGO_USER: triple_user
      MONGO_PASS: triple_password
    EOF
    
    # 2. SealedSecret으로 변환
    kubeseal -o yaml < secret.yaml > sealed-secret.yaml
    
    # 3. 평문 Secret 파일 삭제
    rm secret.yaml
    
    # 4. SealedSecret 적용
    kubectl apply -f sealed-secret.yaml
    ```
    
    ### 방법 2: 개별 값 암호화
    ```bash
    # 개별 값 암호화
    echo -n 'triple_user' | kubeseal --raw --from-file=/dev/stdin --namespace apc-be-ns --name alphacar-be-secret
    ```
    
    ## 3. Sealed Secret 확인
    ```bash
    # SealedSecret 리소스 확인
    kubectl get sealedsecrets -n apc-be-ns
    
    # Controller가 생성한 Secret 확인
    kubectl get secrets -n apc-be-ns
    
    # SealedSecret 상세 정보
    kubectl describe sealedsecret alphacar-be-secret -n apc-be-ns
    ```
    
    ## 4. Sealed Secret 업데이트
    ```bash
    # Secret YAML 수정 후 다시 암호화
    kubeseal -o yaml < secret.yaml > sealed-secret.yaml
    kubectl apply -f sealed-secret.yaml
    ```
    
    ## 5. Sealed Secret 복구 키 백업
    ```bash
    # Sealed Secrets Controller의 private key 백업 (매우 중요!)
    kubectl get secret -n sealed-secrets -l sealedsecrets.bitnami.com/sealed-secrets-key=active -o yaml > sealed-secrets-key-backup.yaml
    ```

---
# 5. SealedSecret 예제 템플릿
# 사용법: kubeseal < secret.yaml > sealed-secret.yaml
# 또는: echo -n 'secret-value' | kubeseal --raw --from-file=/dev/stdin

# 예제: alphacar-be-secret을 SealedSecret으로 변환
# 1. Secret YAML 파일 생성
# 2. kubeseal -o yaml < secret.yaml > sealed-secret.yaml
# 3. Git에 sealed-secret.yaml 커밋

apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: alphacar-be-secret
  namespace: apc-be-ns
  labels:
    component: security
    policy: sealed-secret
spec:
  encryptedData:
    # 이 값들은 kubeseal로 암호화된 값으로 교체 필요
    # 예: echo -n 'triple_user' | kubeseal --raw --from-file=/dev/stdin --namespace apc-be-ns --name alphacar-be-secret
    MONGO_USER: <ENCRYPTED_VALUE>
    MONGO_PASS: <ENCRYPTED_VALUE>
    MONGO_DB_NAME: <ENCRYPTED_VALUE>
    MARIADB_USER: <ENCRYPTED_VALUE>
    MARIADB_PASS: <ENCRYPTED_VALUE>
    MARIADB_DB_NAME: <ENCRYPTED_VALUE>
    JWT_SECRET: <ENCRYPTED_VALUE>
    AWS_ACCESS_KEY_ID: <ENCRYPTED_VALUE>
    AWS_SECRET_ACCESS_KEY: <ENCRYPTED_VALUE>
  template:
    metadata:
      name: alphacar-be-secret
      namespace: apc-be-ns
      labels:
        component: backend
        managed-by: sealed-secrets
    type: Opaque

---
# 6. SealedSecret 네임스페이스별 접근 제어
# SealedSecret이 생성하는 Secret에 대한 접근 제어
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: backend-secret-reader
  namespace: apc-be-ns
  labels:
    component: security
    policy: sealed-secret
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames:
      - alphacar-be-secret
      - alphacar-aichat-secret
      - harbor-registry-secret
    verbs: ["get"]

---
# 8. Sealed Secret 백업 정책
# Sealed Secrets Controller의 private key 백업 (매우 중요!)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: sealed-secrets-key-backup
  namespace: apc-sealed-secrets-ns
  labels:
    component: security
    policy: sealed-secret
spec:
  schedule: "0 2 * * *"  # 매일 새벽 2시
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 7
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: sealed-secrets-backup
        spec:
          serviceAccountName: sealed-secrets-backup-sa
          containers:
          - name: backup
            image: bitnami/kubectl:latest
            command:
            - /bin/sh
            - -c
            - |
              # Sealed Secrets Controller의 private key 백업
              echo "Backing up Sealed Secrets private key..."
              kubectl get secret -n sealed-secrets -l sealedsecrets.bitnami.com/sealed-secrets-key=active -o yaml > /backup/sealed-secrets-key-$(date +%Y%m%d).yaml
              echo "Backup completed: sealed-secrets-key-$(date +%Y%m%d).yaml"
          restartPolicy: OnFailure
          volumes:
          - name: backup
            persistentVolumeClaim:
              claimName: sealed-secrets-backup-pvc

---
# 9. Sealed Secret 모니터링
# Sealed Secrets Controller 메트릭 수집
apiVersion: v1
kind: Service
metadata:
  name: sealed-secrets-controller-metrics
  namespace: apc-sealed-secrets-ns
  labels:
    app: sealed-secrets-controller
    component: security
    policy: sealed-secret
spec:
  selector:
    app: sealed-secrets-controller
  ports:
  - name: http-metrics
    port: 8080
    targetPort: 8080

