# Park Secret Policy
# Secret 관리 및 자동 로테이션 정책
# 목적: Secret의 생명주기 관리 및 자동 로테이션

---
# 1. Secret 로테이션 정책 정의
apiVersion: v1
kind: ConfigMap
metadata:
  name: secret-rotation-policy
  namespace: apc-sealed-secrets-ns
  labels:
    component: security
    policy: park-secret
data:
  # Secret별 로테이션 주기 (일 단위)
  rotation-schedule.yaml: |
    secrets:
      - name: alphacar-be-secret
        namespace: apc-be-ns
        rotation-days: 90
        keys:
          - MONGO_PASS
          - MARIADB_PASS
          - JWT_SECRET
          - AWS_SECRET_ACCESS_KEY
        auto-rotation: false  # 수동 로테이션
        notify-before-days: 7
        
      - name: alphacar-aichat-secret
        namespace: apc-be-ns
        rotation-days: 90
        keys:
          - MONGO_PASS
          - AWS_SECRET_ACCESS_KEY
        auto-rotation: false
        notify-before-days: 7
        
      - name: harbor-registry-secret
        namespace: apc-be-ns
        rotation-days: 180
        auto-rotation: true  # 자동 로테이션
        notify-before-days: 14

---
# 2. Secret 만료 감시 CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: secret-expiry-checker
  namespace: apc-sealed-secrets-ns
  labels:
    component: security
    policy: park-secret
spec:
  schedule: "0 9 * * *"  # 매일 오전 9시
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: secret-expiry-checker
        spec:
          serviceAccountName: secret-manager-sa
          containers:
          - name: checker
            image: bitnami/kubectl:latest
            command:
            - /bin/sh
            - -c
            - |
              # Secret 만료 확인 스크립트
              # 실제 구현은 별도 스크립트 필요
              echo "Checking secret expiry..."
              kubectl get secrets --all-namespaces -o json | \
                jq -r '.items[] | select(.metadata.annotations."park-secret/expiry-date") | 
                "\(.metadata.namespace)/\(.metadata.name): \(.metadata.annotations."park-secret/expiry-date")"'
          restartPolicy: OnFailure

---
# 3. Secret 로테이션을 위한 ServiceAccount 및 RBAC
apiVersion: v1
kind: ServiceAccount
metadata:
  name: secret-manager-sa
  namespace: apc-sealed-secrets-ns
  labels:
    component: security
    policy: park-secret
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: secret-rotator
  labels:
    component: security
    policy: park-secret
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "create", "update", "patch"]
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["list"]
    # Pod 재시작을 위한 권한
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: secret-rotator-binding
  labels:
    component: security
    policy: park-secret
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: secret-rotator
subjects:
  - kind: ServiceAccount
    name: secret-manager-sa
    namespace: apc-sealed-secrets-ns

---
# 4. Secret 버전 관리 정책
# Secret 변경 시 이전 버전 보관
apiVersion: v1
kind: ConfigMap
metadata:
  name: secret-version-policy
  namespace: apc-sealed-secrets-ns
  labels:
    component: security
    policy: park-secret
data:
  version-policy.yaml: |
    retention:
      versions: 5  # 최근 5개 버전 보관
      days: 30     # 30일 이상 된 버전 삭제
    backup:
      enabled: true
      storage-class: longhorn
      schedule: "0 3 * * *"  # 매일 새벽 3시

---
# 5. Secret 사용 현황 추적
# 어떤 Pod가 어떤 Secret을 사용하는지 추적
apiVersion: v1
kind: ConfigMap
metadata:
  name: secret-usage-tracker
  namespace: apc-sealed-secrets-ns
  labels:
    component: security
    policy: park-secret
data:
  tracking-policy.yaml: |
    track:
      - namespace: apc-be-ns
        secrets:
          - alphacar-be-secret
          - alphacar-aichat-secret
          - harbor-registry-secret
    alert:
      unused-secrets-days: 90  # 90일 미사용 Secret 알림
      high-usage-secrets: true  # 높은 사용량 Secret 모니터링

---
# 6. Secret 생성 템플릿 및 검증
# Secret 생성 시 표준 형식 강제
apiVersion: v1
kind: ConfigMap
metadata:
  name: secret-template-policy
  namespace: apc-sealed-secrets-ns
  labels:
    component: security
    policy: park-secret
data:
  required-labels.yaml: |
    labels:
      - security.classification
      - secret.type
      - secret.rotation
      - secret.created-by
    annotations:
      - park-secret/created-date
      - park-secret/expiry-date
      - park-secret/rotation-policy
      - park-secret/last-rotated

---
# 7. Secret 접근 로깅 및 감사
# Secret 접근 시 상세 로그 기록
apiVersion: v1
kind: ConfigMap
metadata:
  name: secret-audit-policy
  namespace: apc-sealed-secrets-ns
  labels:
    component: security
    policy: park-secret
data:
  audit-config.yaml: |
    log-level: "detailed"  # basic, detailed, full
    log-events:
      - secret-read
      - secret-write
      - secret-delete
      - secret-rotation
    retention-days: 90
    alert-on:
      - unauthorized-access
      - bulk-secret-read
      - secret-deletion

---
# 8. Secret 자동 백업 (Velero 연동)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: secret-backup
  namespace: apc-sealed-secrets-ns
  labels:
    component: security
    policy: park-secret
spec:
  schedule: "0 2 * * *"  # 매일 새벽 2시
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 7
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: secret-backup
        spec:
          serviceAccountName: secret-manager-sa
          containers:
          - name: backup
            image: velero/velero:latest
            command:
            - /bin/sh
            - -c
            - |
              # Secret 백업 스크립트
              # 실제 구현은 Velero CLI 사용
              echo "Backing up secrets..."
              # velero backup create secret-backup-$(date +%Y%m%d) \
              #   --include-namespaces apc-be-ns,apc-fe-ns,apc-db-ns \
              #   --include-resources secrets
          restartPolicy: OnFailure

