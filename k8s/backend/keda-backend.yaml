# 0. Main Backend Scaler (메인 서비스)
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: main-backend-scaler
  namespace: apc-be-ns
spec:
  scaleTargetRef:
    name: main-backend
  minReplicaCount: 1
  maxReplicaCount: 10
  cooldownPeriod: 30
  triggers:
    - type: cpu
      metricType: Utilization
      metadata:
        value: "60"
    - type: prometheus
      metadata:
        # [수정 완료] 내부 DNS 주소 사용으로 타임아웃 해결
        serverAddress: http://prometheus.apc-obsv-ns.svc.cluster.local:9090
        metricName: http_requests_total
        query: sum(rate(http_requests_total{job="main-backend"}[30s]))
        threshold: "10"
        ignoreNullValues: "true"
---
# 1. Quote Backend Scaler (견적 서비스)
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: quote-backend-scaler
  namespace: apc-be-ns
spec:
  scaleTargetRef:
    name: quote-backend
  minReplicaCount: 1
  maxReplicaCount: 10
  cooldownPeriod: 60
  triggers:
    - type: cpu
      metricType: Utilization
      metadata:
        value: "60"
    - type: prometheus
      metadata:
        # [수정 완료] 내부 DNS 주소 사용
        serverAddress: http://prometheus.apc-obsv-ns.svc.cluster.local:9090
        metricName: http_requests_total
        query: sum(rate(http_requests_total{job="quote-backend"}[2m]))
        threshold: "50"
        ignoreNullValues: "true"
---
# 2. Search Backend Scaler (검색 서비스)
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: search-backend-scaler
  namespace: apc-be-ns
spec:
  scaleTargetRef:
    name: search-backend
  minReplicaCount: 1
  maxReplicaCount: 10
  cooldownPeriod: 60
  triggers:
    - type: cpu
      metricType: Utilization
      metadata:
        value: "60"
    - type: prometheus
      metadata:
        # [수정 완료] 내부 DNS 주소 사용
        serverAddress: http://prometheus.apc-obsv-ns.svc.cluster.local:9090
        metricName: http_requests_total
        query: sum(rate(http_requests_total{job="search-backend"}[2m]))
        threshold: "50"
        ignoreNullValues: "true"
---
# 3. AiChat Backend Scaler (AI 채팅 서비스)
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: aichat-backend-scaler
  namespace: apc-be-ns
spec:
  scaleTargetRef:
    name: aichat-backend
  minReplicaCount: 1
  maxReplicaCount: 10
  cooldownPeriod: 60
  triggers:
    - type: cpu
      metricType: Utilization
      metadata:
        value: "50"
    - type: prometheus
      metadata:
        # [수정 완료] 내부 DNS 주소 사용
        serverAddress: http://prometheus.apc-obsv-ns.svc.cluster.local:9090
        metricName: http_requests_total
        query: sum(rate(http_requests_total{job="aichat-backend"}[2m]))
        threshold: "20"
        ignoreNullValues: "true"
