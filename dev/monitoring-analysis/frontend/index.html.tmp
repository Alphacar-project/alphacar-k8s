<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ë‹ˆí„°ë§ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
            background: #1f1f23;
            background-attachment: fixed;
            min-height: 100vh;
            color: #d8d9da;
        }
        .header {
            background: #2b2b2f;
            backdrop-filter: blur(10px);
            color: #d8d9da;
            padding: 20px 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border-bottom: 1px solid #3d3d42;
        }
        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #d8d9da;
            margin: 0;
        }
        .header p {
            color: #9e9e9e;
            font-size: 13px;
            margin-top: 5px;
        }
        .container {
            max-width: 1800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .card {
            background: #2b2b2f;
            border-radius: 4px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 1px solid #3d3d42;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            border-color: #464650;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .card h2 {
            font-size: 16px;
            margin-bottom: 16px;
            color: #d8d9da;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #3d3d42;
            padding-bottom: 12px;
        }
        .btn {
            background: #3274d9;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            margin: 4px;
            transition: all 0.2s ease;
            box-shadow: none;
        }
        .btn:hover {
            background: #4080e8;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .btn:active { transform: translateY(1px); }
        .btn-danger {
            background: #d32f2f;
            box-shadow: none;
        }
        .btn-danger:hover {
            background: #e53935;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .status {
            padding: 10px 14px;
            border-radius: 2px;
            margin: 10px 0;
            font-weight: 400;
            border-left: 3px solid;
            font-size: 13px;
        }
        .status.success {
            background: rgba(46, 160, 67, 0.15);
            color: #73bf69;
            border-left-color: #73bf69;
        }
        .status.error {
            background: rgba(211, 47, 47, 0.15);
            color: #e57373;
            border-left-color: #e57373;
        }
        .status.warning {
            background: rgba(237, 212, 0, 0.15);
            color: #fdd835;
            border-left-color: #fdd835;
        }
        .result-box {
            background: #1a202c;
            color: #e2e8f0;
            border: 1px solid #2d3748;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        .result-box::-webkit-scrollbar {
            width: 8px;
        }
        .result-box::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 4px;
        }
        .result-box::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }
        .analysis-result {
            background: #2b2b2f;
            border: 1px solid #3d3d42;
            border-radius: 2px;
            padding: 16px;
            margin-top: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .analysis-result h3 {
            color: #d8d9da;
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            border-bottom: 1px solid #3d3d42;
            padding-bottom: 8px;
        }
        .analysis-text {
            background: #1f1f23;
            padding: 12px;
            border-radius: 2px;
            line-height: 1.6;
            white-space: pre-line;
            margin-bottom: 12px;
            font-size: 13px;
            color: #d8d9da;
            box-shadow: inset 0 0 0 1px #3d3d42;
            border-left: 2px solid #3274d9;
        }
        .analysis-text strong {
            color: #3274d9;
            font-weight: 500;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 16px;
            background: #1f1f23;
            border-radius: 2px;
            padding: 12px;
            box-shadow: inset 0 0 0 1px #3d3d42;
        }
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden { display: none; }
        input, select {
            width: 100%;
            padding: 8px 12px;
            margin: 6px 0;
            border: 1px solid #3d3d42;
            border-radius: 2px;
            font-size: 13px;
            transition: all 0.2s ease;
            background: #1f1f23;
            color: #d8d9da;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3274d9;
            box-shadow: 0 0 0 2px rgba(50, 116, 217, 0.2);
        }
        input::placeholder {
            color: #6e6e73;
        }
        .metric-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 500;
            margin: 2px;
        }
        .badge-success { background: rgba(46, 160, 67, 0.2); color: #73bf69; border: 1px solid rgba(46, 160, 67, 0.3); }
        .badge-warning { background: rgba(237, 212, 0, 0.2); color: #fdd835; border: 1px solid rgba(237, 212, 0, 0.3); }
        .badge-danger { background: rgba(211, 47, 47, 0.2); color: #e57373; border: 1px solid rgba(211, 47, 47, 0.3); }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="header">
        <h1>â˜¸ï¸ Kubernetes ì˜µì €ë¹Œë¦¬í‹° ëŒ€ì‹œë³´ë“œ</h1>
        <p style="margin-top: 10px; color: #666; font-size: 14px;">AI ê¸°ë°˜ í´ëŸ¬ìŠ¤í„° ìƒíƒœ ë¶„ì„ ë° ë¬¸ì œ í•´ê²°</p>
    </div>
    <div class="container">
        <!-- K8s í´ëŸ¬ìŠ¤í„° ìƒíƒœ (ìµœìƒë‹¨) -->
        <div class="card" style="grid-column: 1 / -1; margin-bottom: 30px;">
            <h2>â˜¸ï¸ Kubernetes í´ëŸ¬ìŠ¤í„° ìƒíƒœ</h2>
            <button class="btn" onclick="checkK8sStatus()">ğŸ”„ ìƒíƒœ ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn" onclick="autoRefreshToggle()" id="autoRefreshBtn">â¸ï¸ ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€</button>
            <div id="k8sStatus"></div>
            <div id="k8sStatusResult" class="hidden"></div>
        </div>

        <div class="grid">
            <!-- ë©”íŠ¸ë¦­ ë¶„ì„ (K8s ì¤‘ì‹¬) -->
            <div class="card">
                <h2>ğŸ“ˆ K8s ë©”íŠ¸ë¦­ ë¶„ì„</h2>
                <select id="k8sMetricsQuery" style="margin-bottom: 10px;">
                    <option value="up">í´ëŸ¬ìŠ¤í„° ê°€ìš©ì„± (up)</option>
                    <option value="kube_pod_status_phase">Pod ìƒíƒœ ë¶„í¬</option>
                    <option value="kube_node_status_condition">ë…¸ë“œ ìƒíƒœ</option>
                    <option value="container_cpu_usage_seconds_total">CPU ì‚¬ìš©ë¥ </option>
                    <option value="container_memory_working_set_bytes">ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰</option>
                    <option value="kube_pod_container_status_restarts_total">Pod ì¬ì‹œì‘ íšŸìˆ˜</option>
                </select>
                <input type="text" id="metricsQuery" placeholder="ë˜ëŠ” ì§ì ‘ PromQL ì…ë ¥" style="margin-bottom: 10px;">
                <button class="btn" onclick="analyzeMetrics()">ë¶„ì„ ì‹œì‘</button>
                <div id="metricsStatus"></div>
                <div id="metricsAnalysis" class="hidden"></div>
                <div id="metricsChart" class="chart-container hidden"></div>
                <div id="metricsResult" class="result-box hidden"></div>
            </div>

            <!-- ë¡œê·¸ ë¶„ì„ (K8s Pod ì¤‘ì‹¬) -->
            <div class="card">
                <h2>ğŸ“ K8s Pod ë¡œê·¸ ë¶„ì„</h2>
                <input type="text" id="podName" placeholder="Pod ì´ë¦„ (ì„ íƒì‚¬í•­, ì˜ˆ: chaos-crashloop-test)">
                <input type="text" id="namespace" placeholder="ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (ì„ íƒì‚¬í•­, ì˜ˆ: alphacar-chaos-ns)">
                <select id="logLevel" style="margin-top: 10px;"><option value="error">Error</option><option value="warning">Warning</option><option value="info">Info</option></select>
                <input type="number" id="logHours" placeholder="ì‹œê°„ ë²”ìœ„ (ì‹œê°„)" value="1" min="1" max="24" style="margin-top: 10px;">
                <button class="btn" onclick="analyzeLogs()">ë¶„ì„ ì‹œì‘</button>
                <div id="logsStatus"></div>
                <div id="logsAnalysis" class="hidden"></div>
                <div id="logsResult" class="result-box hidden"></div>
            </div>

            <!-- íŠ¸ë ˆì´ìŠ¤ ë¶„ì„ -->
            <div class="card">
                <h2>ğŸ” íŠ¸ë ˆì´ìŠ¤ ë¶„ì„</h2>
                <input type="text" id="traceService" placeholder="ì„œë¹„ìŠ¤ ì´ë¦„ (ì„ íƒì‚¬í•­)">
                <button class="btn" onclick="analyzeTraces()">ë¶„ì„ ì‹œì‘</button>
                <div id="tracesStatus"></div>
                <div id="tracesAnalysis" class="hidden"></div>
                <div id="tracesChart" class="chart-container hidden"></div>
                <div id="tracesResult" class="result-box hidden"></div>
            </div>
        </div>
    </div>
    <script>
        const API_BASE = '/api';
        let metricsChart = null;
        let tracesChart = null;
        let autoRefreshInterval = null;
        let autoRefreshEnabled = true;

        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜ (XSS ë°©ì§€ ë° ì½”ë“œ ë…¸ì¶œ ë²„ê·¸ ìˆ˜ì •)
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // í…ìŠ¤íŠ¸ë¥¼ ì•ˆì „í•˜ê²Œ HTMLë¡œ ë³€í™˜ (ì¤„ë°”ê¿ˆ ì²˜ë¦¬ í¬í•¨)
        function safeHtml(text) {
            if (!text) return '';
            return escapeHtml(text).replace(/\n/g, '<br>');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ K8s ìƒíƒœ ì²´í¬
        window.addEventListener('load', () => {
            checkK8sStatus();
            startAutoRefresh();
        });

        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                if (autoRefreshEnabled) {
                    checkK8sStatus();
                }
            }, 30000); // 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
        }

        function autoRefreshToggle() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const btn = document.getElementById('autoRefreshBtn');
            if (autoRefreshEnabled) {
                btn.textContent = 'â¸ï¸ ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn');
            } else {
                btn.textContent = 'â–¶ï¸ ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘';
                btn.classList.remove('btn');
                btn.classList.add('btn-danger');
            }
        }

        async function checkK8sStatus() {
            const statusDiv = document.getElementById('k8sStatus');
            const resultDiv = document.getElementById('k8sStatusResult');
            statusDiv.innerHTML = '<div class="loading"></div> í´ëŸ¬ìŠ¤í„° ìƒíƒœ í™•ì¸ ì¤‘...';
            resultDiv.classList.add('hidden');

            try {
                const res = await fetch(`${API_BASE}/k8s/status`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(30000)
                });

                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                const data = await res.json();

                // ìƒíƒœ ë°°ì§€ ìƒì„±
                let statusBadge = '';
                let statusColor = '';
                if (data.status === 'healthy') {
                    statusBadge = 'ğŸŸ¢ ì •ìƒ';
                    statusColor = '#28a745';
                } else if (data.status === 'warning') {
                    statusBadge = 'ğŸŸ¡ ì£¼ì˜';
                    statusColor = '#ffc107';
                } else if (data.status === 'critical') {
                    statusBadge = 'ğŸ”´ ìœ„ê¸‰';
                    statusColor = '#dc3545';
                } else {
                    statusBadge = 'âšª ì•Œ ìˆ˜ ì—†ìŒ';
                    statusColor = '#6c757d';
                }

                // ê±´ê°• ì ìˆ˜ í‘œì‹œ
                let healthScoreHtml = `
                    <div style="display: flex; align-items: center; gap: 20px; margin: 20px 0;">
                        <div style="flex: 1;">
                            <div style="font-size: 48px; font-weight: 700; color: ${statusColor};">
                                ${data.healthScore}
                            </div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">ê±´ê°• ì ìˆ˜ / 100</div>
                        </div>
                        <div style="flex: 2;">
                            <div style="background: #f0f0f0; height: 30px; border-radius: 15px; overflow: hidden; position: relative;">
                                <div style="background: ${statusColor}; height: 100%; width: ${data.healthScore}%; transition: width 0.5s ease;"></div>
                            </div>
                        </div>
                        <div style="flex: 1; text-align: right;">
                            <div style="font-size: 24px; font-weight: 600; color: ${statusColor};">
                                ${statusBadge}
                            </div>
                        </div>
                    </div>
                `;

                // ê²½ê³  ìš”ì•½
                let alertsSummary = '';
                if (data.criticalCount > 0 || data.warningCount > 0) {
                    alertsSummary = `
                        <div style="margin: 20px 0; padding: 15px; background: ${data.criticalCount > 0 ? '#f8d7da' : '#fff3cd'}; border-radius: 8px; border-left: 4px solid ${data.criticalCount > 0 ? '#dc3545' : '#ffc107'};">
                            <strong style="font-size: 16px;">âš ï¸ ë°œê²¬ëœ ë¬¸ì œ:</strong>
                            <div style="margin-top: 10px;">
                                ${data.criticalCount > 0 ? `<span style="color: #dc3545; font-weight: 600;">ğŸ”´ Critical: ${data.criticalCount}ê°œ</span>` : ''}
                                ${data.warningCount > 0 ? `<span style="color: #856404; font-weight: 600; margin-left: ${data.criticalCount > 0 ? '15px' : '0'};">ğŸŸ¡ Warning: ${data.warningCount}ê°œ</span>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    alertsSummary = `
                        <div style="margin: 20px 0; padding: 15px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
                            <strong style="font-size: 16px; color: #155724;">âœ… ë¬¸ì œ ì—†ìŒ</strong>
                            <div style="margin-top: 5px; color: #155724;">í´ëŸ¬ìŠ¤í„°ê°€ ì •ìƒì ìœ¼ë¡œ ìš´ì˜ë˜ê³  ìˆìŠµë‹ˆë‹¤.</div>
                        </div>
                    `;
                }

                // AI ë¶„ì„ í‘œì‹œ (HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬)
                let aiAnalysisHtml = '';
                if (data.aiAnalysis) {
                    const formattedAnalysis = data.aiAnalysis.replace(/\\n/g, '\n');
                    aiAnalysisHtml = `
                        <div class="analysis-result" style="margin-top: 20px;">
                            <h3>ğŸ¤– AI ë¶„ì„ ê²°ê³¼</h3>
                            <div class="analysis-text">${safeHtml(formattedAnalysis)}</div>
                        </div>
                    `;
                }

                // ë°œê²¬ëœ ë¬¸ì œë“¤ ìƒì„¸ í‘œì‹œ
                let alertsHtml = '';
                if (data.alerts && data.alerts.length > 0) {
                    alertsHtml = '<div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">';
                    alertsHtml += '<h4 style="margin-bottom: 15px; color: #856404;">ğŸ’¡ ë°œê²¬ëœ ë¬¸ì œ ë° í•´ê²°ì±…</h4>';

                    data.alerts.forEach(alert => {
                        const severityColor = alert.severity === 'critical' ? '#dc3545' : '#ffc107';
                        alertsHtml += `<div style="margin-bottom: 20px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #ddd; border-left: 4px solid ${severityColor};">`;
                        alertsHtml += `<strong style="font-size: 14px; color: #333;">${alert.metric} (${alert.value})</strong><br>`;

                        if (alert.location) {
                            alertsHtml += `<div style="margin-top: 8px; margin-bottom: 8px; padding: 8px; background: #e7f3ff; border-radius: 4px; border-left: 3px solid #2196F3;">`;
                            alertsHtml += `<strong style="font-size: 12px; color: #1976D2;">ğŸ“ ë¬¸ì œ ìœ„ì¹˜:</strong><br>`;
                            alertsHtml += `<span style="font-size: 12px; color: #555; font-family: monospace;">${alert.location}</span>`;
                            alertsHtml += `</div>`;
                        }

                        alertsHtml += `<div style="margin-top: 8px; margin-bottom: 12px; font-size: 13px; color: #666; line-height: 1.5;">${safeHtml(alert.analysis || '')}</div>`;

                        if (alert.solutions && alert.solutions.length > 0) {
                            alertsHtml += `<div style="margin-top: 12px;"><strong style="font-size: 12px; color: #856404;">í•´ê²° ë°©ë²•:</strong></div>`;
                            alert.solutions.forEach((sol, idx) => {
                                const btnClass = sol.autoExecutable ? 'btn' : 'btn btn-secondary';
                                const btnText = sol.autoExecutable ? 'âœ… ì‹¤í–‰' : 'ğŸ“‹ ìˆ˜ë™ ì¡°ì¹˜';
                                alertsHtml += `<div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">`;
                                alertsHtml += `<button class="${btnClass}" onclick="executeSolution('${sol.id}', '${sol.action}', '${alert.metric}')" style="margin: 5px 5px 5px 0; font-size: 12px; padding: 6px 12px;">${btnText}</button>`;
                                alertsHtml += `<div style="margin-top: 5px; font-size: 12px; color: #666; margin-left: 0;">`;
                                alertsHtml += `<strong>${escapeHtml(sol.name || '')}:</strong> ${safeHtml(sol.description || '')}`;

                                if (sol.command) {
                                    alertsHtml += `<div style="margin-top: 8px; padding: 8px; background: #2d2d2d; border-radius: 4px; overflow-x: auto;">`;
                                    alertsHtml += `<code style="color: #f8f8f2; font-size: 11px; font-family: 'Courier New', monospace; white-space: pre-wrap; word-break: break-all;">${sol.command}</code>`;
                                    alertsHtml += `</div>`;
                                }

                                alertsHtml += `</div></div>`;
                            });
                        }

                        alertsHtml += `</div>`;
                    });

                    alertsHtml += '</div>';
                }

                statusDiv.innerHTML = healthScoreHtml + alertsSummary + aiAnalysisHtml + alertsHtml;
                resultDiv.classList.remove('hidden');
                showResult('k8sStatusResult', data);
            } catch (e) {
                const errorMsg = e.name === 'AbortError' ? 'ìš”ì²­ ì‹œê°„ ì´ˆê³¼ (30ì´ˆ)' : e.message;
                statusDiv.innerHTML = `<div class="status error">âŒ ì—ëŸ¬: ${errorMsg}</div>`;
                console.error('K8s status check error:', e);
            }
        }

        function showStatus(id, msg, type='success') {
            document.getElementById(id).innerHTML = `<div class="status ${type}">${msg}</div>`;
        }
        function showResult(id, data) {
            const el = document.getElementById(id);
            el.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
            el.classList.remove('hidden');
        }
        function showLoading(id) {
            document.getElementById(id).innerHTML = '<div class="loading"></div> ë¶„ì„ ì¤‘...';
        }

        async function analyzeMetrics() {
            const k8sQuery = document.getElementById('k8sMetricsQuery').value;
            const customQuery = document.getElementById('metricsQuery').value;
            const query = customQuery || k8sQuery;
            showLoading('metricsStatus');
            try {
                const res = await fetch(`${API_BASE}/analyze/metrics`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, startTime: Date.now() - 3600000, endTime: Date.now() }),
                    signal: AbortSignal.timeout(30000) // 30ì´ˆ íƒ€ì„ì•„ì›ƒ
                });

                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                const data = await res.json();
                showStatus('metricsStatus', 'âœ… ë¶„ì„ ì™„ë£Œ', 'success');

                if (data.analysis) {
                    const analysisDiv = document.getElementById('metricsAnalysis');
                    // ì¤„ë°”ê¿ˆ ì²˜ë¦¬: \nì„ ì‹¤ì œ ì¤„ë°”ê¿ˆìœ¼ë¡œ ë³€í™˜
                    const formattedAnalysis = data.analysis.replace(/\\n/g, '\n');

                    // í•´ê²°ì±… UI ìƒì„± (HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬)
                    let solutionsHtml = '';
                    if (data.alerts && data.alerts.length > 0) {
                        solutionsHtml = '<div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">';
                        solutionsHtml += '<h4 style="margin-bottom: 15px; color: #856404;">ğŸ’¡ í•´ê²°ì±…</h4>';

                        data.alerts.forEach(alert => {
                            if (alert.solutions && alert.solutions.length > 0) {
                                solutionsHtml += `<div style="margin-bottom: 20px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #ddd;">`;
                                solutionsHtml += `<strong style="font-size: 14px; color: #333;">${alert.metric} (${alert.value})</strong><br>`;

                                // ìœ„ì¹˜ ì •ë³´ í‘œì‹œ
                                if (alert.location) {
                                    solutionsHtml += `<div style="margin-top: 8px; margin-bottom: 8px; padding: 8px; background: #e7f3ff; border-radius: 4px; border-left: 3px solid #2196F3;">`;
                                    solutionsHtml += `<strong style="font-size: 12px; color: #1976D2;">ğŸ“ ë¬¸ì œ ìœ„ì¹˜:</strong><br>`;
                                    solutionsHtml += `<span style="font-size: 12px; color: #555; font-family: monospace;">${alert.location}</span>`;
                                    solutionsHtml += `</div>`;
                                }

                                solutionsHtml += `<div style="margin-top: 8px; margin-bottom: 12px; font-size: 13px; color: #666; line-height: 1.5;">${safeHtml(alert.analysis || '')}</div>`;

                                solutionsHtml += `<div style="margin-top: 12px;"><strong style="font-size: 12px; color: #856404;">í•´ê²° ë°©ë²•:</strong></div>`;
                                alert.solutions.forEach((sol, idx) => {
                                    const btnClass = sol.autoExecutable ? 'btn' : 'btn btn-secondary';
                                    const btnText = sol.autoExecutable ? 'âœ… ì‹¤í–‰' : 'ğŸ“‹ ìˆ˜ë™ ì¡°ì¹˜';
                                    solutionsHtml += `<div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">`;
                                    solutionsHtml += `<button class="${btnClass}" onclick="executeSolution('${sol.id}', '${sol.action}', '${alert.metric}')" style="margin: 5px 5px 5px 0; font-size: 12px; padding: 6px 12px;">${btnText}</button>`;
                                    solutionsHtml += `<div style="margin-top: 5px; font-size: 12px; color: #666; margin-left: 0;">`;
                                    solutionsHtml += `<strong>${escapeHtml(sol.name || '')}:</strong> ${safeHtml(sol.description || '')}`;

                                    // ëª…ë ¹ì–´ê°€ ìˆìœ¼ë©´ í‘œì‹œ
                                    if (sol.command) {
                                        solutionsHtml += `<div style="margin-top: 8px; padding: 8px; background: #2d2d2d; border-radius: 4px; overflow-x: auto;">`;
                                        solutionsHtml += `<code style="color: #f8f8f2; font-size: 11px; font-family: 'Courier New', monospace; white-space: pre-wrap; word-break: break-all;">${sol.command}</code>`;
                                        solutionsHtml += `</div>`;
                                    }

                                    solutionsHtml += `</div></div>`;
                                });

                                solutionsHtml += `</div>`;
                            }
                        });

                        solutionsHtml += '</div>';
                    }

                    analysisDiv.innerHTML = `
                        <div class="analysis-result">
                            <h3>ğŸ¤– AI ë¶„ì„ ê²°ê³¼</h3>
                            <div class="analysis-text">${safeHtml(formattedAnalysis)}</div>
                            ${solutionsHtml}
                        </div>
                    `;
                    analysisDiv.classList.remove('hidden');
                }

                if (data.graphData && data.graphData.length > 0) {
                    const ctx = document.createElement('canvas');
                    const chartDiv = document.getElementById('metricsChart');
                    chartDiv.innerHTML = '';
                    chartDiv.appendChild(ctx);
                    chartDiv.classList.remove('hidden');

                    if (metricsChart) metricsChart.destroy();
                    metricsChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.graphData.map(d => new Date(d.timestamp * 1000).toLocaleTimeString()),
                            datasets: [{
                                label: query,
                                data: data.graphData.map(d => parseFloat(d.value)),
                                borderColor: '#3274d9',
                                backgroundColor: 'rgba(50, 116, 217, 0.1)',
                                tension: 0.4,
                                pointRadius: 2,
                                pointHoverRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { 
                                    display: true, 
                                    text: 'ë©”íŠ¸ë¦­ ì¶”ì´',
                                    color: '#d8d9da',
                                    font: { size: 13 }
                                },
                                legend: {
                                    labels: { color: '#d8d9da', font: { size: 12 } }
                                }
                            },
                            scales: {
                                y: { 
                                    beginAtZero: true,
                                    ticks: { color: '#9e9e9e', font: { size: 11 } },
                                    grid: { color: '#3d3d42' }
                                },
                                x: {
                                    ticks: { color: '#9e9e9e', font: { size: 11 } },
                                    grid: { color: '#3d3d42' }
                                }
                            }
                        }
                    });
                }

                showResult('metricsResult', data);
            } catch (e) {
                const errorMsg = e.name === 'AbortError' ? 'ìš”ì²­ ì‹œê°„ ì´ˆê³¼ (30ì´ˆ)' : e.message;
                showStatus('metricsStatus', `âŒ ì—ëŸ¬: ${errorMsg}`, 'error');
                console.error('Metrics analysis error:', e);
            }
        }

        async function analyzeLogs() {
            const level = document.getElementById('logLevel').value;
            const hours = parseInt(document.getElementById('logHours').value);
            const podName = document.getElementById('podName').value;
            const namespace = document.getElementById('namespace').value;
            showLoading('logsStatus');
            try {
                const res = await fetch(`${API_BASE}/analyze/logs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        level,
                        podName: podName || undefined,
                        namespace: namespace || undefined,
                        startTime: Date.now() - hours * 3600000,
                        endTime: Date.now()
                    }),
                    signal: AbortSignal.timeout(30000)
                });

                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                const data = await res.json();
                showStatus('logsStatus', 'âœ… ë¶„ì„ ì™„ë£Œ', 'success');

                if (data.analysis) {
                    const analysisDiv = document.getElementById('logsAnalysis');
                    const formattedAnalysis = data.analysis.replace(/\\n/g, '\n');
                    analysisDiv.innerHTML = `
                        <div class="analysis-result">
                            <h3>ğŸ¤– AI ë¶„ì„ ê²°ê³¼</h3>
                            <div class="analysis-text">${safeHtml(formattedAnalysis)}</div>
                        </div>
                    `;
                    analysisDiv.classList.remove('hidden');
                }

                showResult('logsResult', data);
            } catch (e) {
                const errorMsg = e.name === 'AbortError' ? 'ìš”ì²­ ì‹œê°„ ì´ˆê³¼ (30ì´ˆ)' : e.message;
                showStatus('logsStatus', `âŒ ì—ëŸ¬: ${errorMsg}`, 'error');
                console.error('Logs analysis error:', e);
            }
        }

        async function analyzeTraces() {
            const service = document.getElementById('traceService').value;
            showLoading('tracesStatus');
            try {
                const res = await fetch(`${API_BASE}/analyze/traces`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ service, startTime: Date.now() - 3600000, endTime: Date.now() }),
                    signal: AbortSignal.timeout(30000)
                });

                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                const data = await res.json();
                showStatus('tracesStatus', 'âœ… ë¶„ì„ ì™„ë£Œ', 'success');

                if (data.analysis) {
                    const analysisDiv = document.getElementById('tracesAnalysis');
                    const formattedAnalysis = data.analysis.replace(/\\n/g, '\n');
                    analysisDiv.innerHTML = `
                        <div class="analysis-result">
                            <h3>ğŸ¤– AI ë¶„ì„ ê²°ê³¼</h3>
                            <div class="analysis-text">${safeHtml(formattedAnalysis)}</div>
                        </div>
                    `;
                    analysisDiv.classList.remove('hidden');
                }

                if (data.traceData && data.traceData.length > 0) {
                    const ctx = document.createElement('canvas');
                    const chartDiv = document.getElementById('tracesChart');
                    chartDiv.innerHTML = '';
                    chartDiv.appendChild(ctx);
                    chartDiv.classList.remove('hidden');

                    if (tracesChart) tracesChart.destroy();
                    tracesChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.traceData.map(d => d.service || 'Unknown'),
                            datasets: [{
                                label: 'ì‘ë‹µ ì‹œê°„ (ms)',
                                data: data.traceData.map(d => d.duration || 0),
                                backgroundColor: '#3274d9'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { 
                                    display: true, 
                                    text: 'ì„œë¹„ìŠ¤ë³„ ì‘ë‹µ ì‹œê°„',
                                    color: '#d8d9da',
                                    font: { size: 13 }
                                },
                                legend: {
                                    labels: { color: '#d8d9da', font: { size: 12 } }
                                }
                            },
                            scales: {
                                y: { 
                                    beginAtZero: true,
                                    ticks: { color: '#9e9e9e', font: { size: 11 } },
                                    grid: { color: '#3d3d42' }
                                },
                                x: {
                                    ticks: { color: '#9e9e9e', font: { size: 11 } },
                                    grid: { color: '#3d3d42' }
                                }
                            }
                        }
                    });
                }

                showResult('tracesResult', data);
            } catch (e) {
                const errorMsg = e.name === 'AbortError' ? 'ìš”ì²­ ì‹œê°„ ì´ˆê³¼ (30ì´ˆ)' : e.message;
                showStatus('tracesStatus', `âŒ ì—ëŸ¬: ${errorMsg}`, 'error');
                console.error('Traces analysis error:', e);
            }
        }

        async function executeSolution(solutionId, action, alertMetric) {
            if (!confirm(`í•´ê²°ì±… "${action}"ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            showStatus('metricsStatus', 'â³ í•´ê²°ì±… ì‹¤í–‰ ì¤‘...', 'warning');

            try {
                const res = await fetch(`${API_BASE}/solution/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        solutionId: solutionId,
                        action: action,
                        alertMetric: alertMetric
                    }),
                    signal: AbortSignal.timeout(30000)
                });

                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                const data = await res.json();

                if (data.success) {
                    showStatus('metricsStatus', `âœ… ${data.message}`, 'success');
                    if (data.estimatedTime) {
                        setTimeout(() => {
                            showStatus('metricsStatus', 'âœ… í•´ê²°ì±… ì‹¤í–‰ ì™„ë£Œ. ì‹œìŠ¤í…œ ìƒíƒœë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.', 'success');
                        }, 2000);
                    }
                } else {
                    showStatus('metricsStatus', `â„¹ï¸ ${data.message}`, 'warning');
                }

                showResult('metricsResult', data);
            } catch (e) {
                const errorMsg = e.name === 'AbortError' ? 'ìš”ì²­ ì‹œê°„ ì´ˆê³¼ (30ì´ˆ)' : e.message;
                showStatus('metricsStatus', `âŒ ì—ëŸ¬: ${errorMsg}`, 'error');
                console.error('Solution execution error:', e);
            }
        }

        function showResult(id, data) {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
            el.classList.remove('hidden');
        }

        async function checkHealth() {
            // K8s ìƒíƒœ ì²´í¬ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            checkK8sStatus();
        }
    </script>
</body>
</html>
HTML_EOF
